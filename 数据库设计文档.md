# AI智能合同审核系统 - 数据库设计文档

## 1. 概述

本文档描述了AI智能合同审核系统的完整数据库设计，包括所有业务模块的数据表结构、关系设计和约束条件。

## 2. 数据库设计原则

- 使用MySQL 8.0作为数据库
- 所有表使用InnoDB存储引擎
- 统一使用UTF8MB4字符集
- 所有表包含创建时间、更新时间字段
- 使用软删除机制（is_deleted字段）

## 3. 核心数据表设计

### 3.1 用户与权限管理模块

#### 3.1.1 用户表 (users_user)
```sql
CREATE TABLE `users_user` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `username` VARCHAR(150) UNIQUE NOT NULL COMMENT '用户名',
  `email` VARCHAR(255) UNIQUE NOT NULL COMMENT '邮箱',
  `password` VARCHAR(255) NOT NULL COMMENT '密码（加密）',
  `real_name` VARCHAR(100) COMMENT '真实姓名',
  `phone` VARCHAR(20) COMMENT '手机号',
  `avatar` VARCHAR(500) COMMENT '头像URL',
  `department_id` BIGINT COMMENT '部门ID',
  `role` VARCHAR(50) DEFAULT 'drafter' COMMENT '角色：admin/reviewer/drafter',
  `is_active` BOOLEAN DEFAULT TRUE COMMENT '是否激活',
  `is_deleted` BOOLEAN DEFAULT FALSE COMMENT '是否删除',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX `idx_username` (`username`),
  INDEX `idx_email` (`email`),
  INDEX `idx_department` (`department_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

#### 3.1.2 部门表 (users_department)
```sql
CREATE TABLE `users_department` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `name` VARCHAR(100) NOT NULL COMMENT '部门名称',
  `parent_id` BIGINT COMMENT '父部门ID',
  `code` VARCHAR(50) UNIQUE COMMENT '部门编码',
  `description` TEXT COMMENT '部门描述',
  `is_deleted` BOOLEAN DEFAULT FALSE,
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX `idx_parent` (`parent_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='部门表';
```

#### 3.1.3 权限表 (users_permission)
```sql
CREATE TABLE `users_permission` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `name` VARCHAR(100) NOT NULL COMMENT '权限名称',
  `code` VARCHAR(100) UNIQUE NOT NULL COMMENT '权限编码',
  `resource` VARCHAR(100) COMMENT '资源类型',
  `action` VARCHAR(50) COMMENT '操作类型',
  `description` TEXT COMMENT '权限描述',
  `is_deleted` BOOLEAN DEFAULT FALSE,
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX `idx_code` (`code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='权限表';
```

#### 3.1.4 角色表 (users_role)
```sql
CREATE TABLE `users_role` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `name` VARCHAR(100) NOT NULL COMMENT '角色名称',
  `code` VARCHAR(50) UNIQUE NOT NULL COMMENT '角色编码',
  `description` TEXT COMMENT '角色描述',
  `is_deleted` BOOLEAN DEFAULT FALSE,
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX `idx_code` (`code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='角色表';
```

#### 3.1.5 角色权限关联表 (users_role_permission)
```sql
CREATE TABLE `users_role_permission` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `role_id` BIGINT NOT NULL COMMENT '角色ID',
  `permission_id` BIGINT NOT NULL COMMENT '权限ID',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_role_permission` (`role_id`, `permission_id`),
  INDEX `idx_role` (`role_id`),
  INDEX `idx_permission` (`permission_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='角色权限关联表';
```

#### 3.1.6 用户角色关联表 (users_user_role)
```sql
CREATE TABLE `users_user_role` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  `role_id` BIGINT NOT NULL COMMENT '角色ID',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_user_role` (`user_id`, `role_id`),
  INDEX `idx_user` (`user_id`),
  INDEX `idx_role` (`role_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户角色关联表';
```

#### 3.1.7 审计日志表 (users_audit_log)
```sql
CREATE TABLE `users_audit_log` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `user_id` BIGINT COMMENT '用户ID',
  `action` VARCHAR(100) NOT NULL COMMENT '操作类型',
  `resource_type` VARCHAR(50) COMMENT '资源类型',
  `resource_id` BIGINT COMMENT '资源ID',
  `ip_address` VARCHAR(50) COMMENT 'IP地址',
  `user_agent` VARCHAR(500) COMMENT '用户代理',
  `request_data` JSON COMMENT '请求数据',
  `response_data` JSON COMMENT '响应数据',
  `status` VARCHAR(20) COMMENT '操作状态：success/failed',
  `error_message` TEXT COMMENT '错误信息',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX `idx_user` (`user_id`),
  INDEX `idx_action` (`action`),
  INDEX `idx_created` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='审计日志表';
```

### 3.2 合同管理模块

#### 3.2.1 合同表 (contracts_contract)
```sql
CREATE TABLE `contracts_contract` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `contract_no` VARCHAR(100) UNIQUE NOT NULL COMMENT '合同编号',
  `title` VARCHAR(500) NOT NULL COMMENT '合同标题',
  `contract_type` VARCHAR(50) NOT NULL COMMENT '合同类型：procurement/sales/labor/service',
  `industry` VARCHAR(50) COMMENT '所属行业',
  `status` VARCHAR(50) DEFAULT 'draft' COMMENT '状态：draft/reviewing/reviewed/approved/rejected/signed',
  `content` LONGTEXT COMMENT '合同内容（JSON格式）',
  `file_path` VARCHAR(500) COMMENT '合同文件路径',
  `file_format` VARCHAR(20) COMMENT '文件格式：word/pdf/txt',
  `template_id` BIGINT COMMENT '使用的模板ID',
  `drafter_id` BIGINT NOT NULL COMMENT '起草人ID',
  `current_version` INT DEFAULT 1 COMMENT '当前版本号',
  `is_deleted` BOOLEAN DEFAULT FALSE,
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX `idx_contract_no` (`contract_no`),
  INDEX `idx_drafter` (`drafter_id`),
  INDEX `idx_status` (`status`),
  INDEX `idx_type` (`contract_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='合同表';
```

#### 3.2.2 合同版本表 (contracts_contract_version)
```sql
CREATE TABLE `contracts_contract_version` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `contract_id` BIGINT NOT NULL COMMENT '合同ID',
  `version` INT NOT NULL COMMENT '版本号',
  `content` LONGTEXT COMMENT '版本内容',
  `file_path` VARCHAR(500) COMMENT '版本文件路径',
  `change_summary` TEXT COMMENT '变更摘要',
  `changed_by` BIGINT NOT NULL COMMENT '变更人ID',
  `is_deleted` BOOLEAN DEFAULT FALSE,
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX `idx_contract` (`contract_id`),
  INDEX `idx_version` (`version`),
  UNIQUE KEY `uk_contract_version` (`contract_id`, `version`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='合同版本表';
```

#### 3.2.3 合同模板表 (contracts_template)
```sql
CREATE TABLE `contracts_template` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `name` VARCHAR(200) NOT NULL COMMENT '模板名称',
  `contract_type` VARCHAR(50) NOT NULL COMMENT '合同类型',
  `industry` VARCHAR(50) COMMENT '适用行业',
  `category` VARCHAR(50) COMMENT '模板分类',
  `content` LONGTEXT NOT NULL COMMENT '模板内容',
  `description` TEXT COMMENT '模板描述',
  `tags` JSON COMMENT '标签列表',
  `usage_count` INT DEFAULT 0 COMMENT '使用次数',
  `is_public` BOOLEAN DEFAULT FALSE COMMENT '是否公开',
  `is_enterprise` BOOLEAN DEFAULT FALSE COMMENT '是否企业模板',
  `created_by` BIGINT COMMENT '创建人ID',
  `enterprise_id` BIGINT COMMENT '企业ID',
  `is_deleted` BOOLEAN DEFAULT FALSE,
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX `idx_type` (`contract_type`),
  INDEX `idx_industry` (`industry`),
  INDEX `idx_public` (`is_public`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='合同模板表';
```

#### 3.2.4 用户习惯表 (contracts_user_habit)
```sql
CREATE TABLE `contracts_user_habit` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  `habit_type` VARCHAR(50) NOT NULL COMMENT '习惯类型：clause_preference/template_preference',
  `habit_key` VARCHAR(200) NOT NULL COMMENT '习惯键',
  `habit_value` JSON COMMENT '习惯值',
  `frequency` INT DEFAULT 1 COMMENT '使用频率',
  `last_used_at` DATETIME COMMENT '最后使用时间',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_user_habit` (`user_id`, `habit_type`, `habit_key`),
  INDEX `idx_user` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户习惯表';
```

### 3.3 合同审核模块

#### 3.3.1 审核任务表 (reviews_review_task)
```sql
CREATE TABLE `reviews_review_task` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `contract_id` BIGINT NOT NULL COMMENT '合同ID',
  `contract_version` INT COMMENT '合同版本号',
  `task_type` VARCHAR(50) DEFAULT 'auto' COMMENT '任务类型：auto/manual',
  `status` VARCHAR(50) DEFAULT 'pending' COMMENT '状态：pending/processing/completed/failed',
  `priority` INT DEFAULT 0 COMMENT '优先级',
  `celery_task_id` VARCHAR(255) COMMENT 'Celery任务ID',
  `started_at` DATETIME COMMENT '开始时间',
  `completed_at` DATETIME COMMENT '完成时间',
  `error_message` TEXT COMMENT '错误信息',
  `created_by` BIGINT COMMENT '创建人ID',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX `idx_contract` (`contract_id`),
  INDEX `idx_status` (`status`),
  INDEX `idx_celery_task` (`celery_task_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='审核任务表';
```

#### 3.3.2 审核结果表 (reviews_review_result)
```sql
CREATE TABLE `reviews_review_result` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `review_task_id` BIGINT NOT NULL COMMENT '审核任务ID',
  `contract_id` BIGINT NOT NULL COMMENT '合同ID',
  `overall_score` DECIMAL(5,2) COMMENT '总体评分',
  `risk_level` VARCHAR(20) COMMENT '风险等级：high/medium/low',
  `risk_count` INT DEFAULT 0 COMMENT '风险数量',
  `summary` TEXT COMMENT '审核摘要',
  `report_path` VARCHAR(500) COMMENT '报告文件路径',
  `report_format` VARCHAR(20) COMMENT '报告格式：word/pdf',
  `review_data` JSON COMMENT '详细审核数据（JSON）',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX `idx_task` (`review_task_id`),
  INDEX `idx_contract` (`contract_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='审核结果表';
```

#### 3.3.3 审核意见表 (reviews_review_opinion)
```sql
CREATE TABLE `reviews_review_opinion` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `review_result_id` BIGINT NOT NULL COMMENT '审核结果ID',
  `reviewer_id` BIGINT COMMENT '审核人ID（人工审核）',
  `clause_id` VARCHAR(100) COMMENT '条款ID',
  `clause_content` TEXT COMMENT '条款内容',
  `opinion_type` VARCHAR(50) COMMENT '意见类型：risk/suggestion/warning',
  `risk_level` VARCHAR(20) COMMENT '风险等级',
  `opinion_content` TEXT NOT NULL COMMENT '意见内容',
  `legal_basis` TEXT COMMENT '法律依据',
  `suggestion` TEXT COMMENT '修改建议',
  `status` VARCHAR(50) DEFAULT 'pending' COMMENT '处理状态：pending/accepted/rejected',
  `is_deleted` BOOLEAN DEFAULT FALSE,
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX `idx_result` (`review_result_id`),
  INDEX `idx_reviewer` (`reviewer_id`),
  INDEX `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='审核意见表';
```

#### 3.3.4 审核意见闭环表 (reviews_review_cycle)
```sql
CREATE TABLE `reviews_review_cycle` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `contract_id` BIGINT NOT NULL COMMENT '合同ID',
  `cycle_no` INT NOT NULL COMMENT '循环序号',
  `review_result_id` BIGINT COMMENT '审核结果ID',
  `opinion_summary` TEXT COMMENT '意见汇总',
  `modification_summary` TEXT COMMENT '修改摘要',
  `status` VARCHAR(50) DEFAULT 'reviewing' COMMENT '状态：reviewing/modifying/completed',
  `submitted_by` BIGINT COMMENT '提交人ID',
  `submitted_at` DATETIME COMMENT '提交时间',
  `modified_by` BIGINT COMMENT '修改人ID',
  `modified_at` DATETIME COMMENT '修改时间',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX `idx_contract` (`contract_id`),
  INDEX `idx_cycle` (`cycle_no`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='审核意见闭环表';
```

### 3.4 规则引擎模块

#### 3.4.1 审核规则表 (rules_review_rule)
```sql
CREATE TABLE `rules_review_rule` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `rule_code` VARCHAR(100) UNIQUE NOT NULL COMMENT '规则编码',
  `rule_name` VARCHAR(200) NOT NULL COMMENT '规则名称',
  `rule_type` VARCHAR(50) NOT NULL COMMENT '规则类型：general/industry/enterprise',
  `industry` VARCHAR(50) COMMENT '适用行业',
  `category` VARCHAR(50) COMMENT '规则分类：legality/compliance/completeness',
  `priority` INT DEFAULT 0 COMMENT '优先级',
  `rule_content` JSON NOT NULL COMMENT '规则内容（JSON格式）',
  `risk_level` VARCHAR(20) COMMENT '风险等级',
  `legal_basis` TEXT COMMENT '法律依据',
  `description` TEXT COMMENT '规则描述',
  `is_active` BOOLEAN DEFAULT TRUE COMMENT '是否启用',
  `version` INT DEFAULT 1 COMMENT '规则版本',
  `created_by` BIGINT COMMENT '创建人ID',
  `is_deleted` BOOLEAN DEFAULT FALSE,
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX `idx_code` (`rule_code`),
  INDEX `idx_type` (`rule_type`),
  INDEX `idx_industry` (`industry`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='审核规则表';
```

#### 3.4.2 规则匹配记录表 (rules_rule_match)
```sql
CREATE TABLE `rules_rule_match` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `review_task_id` BIGINT NOT NULL COMMENT '审核任务ID',
  `rule_id` BIGINT NOT NULL COMMENT '规则ID',
  `contract_id` BIGINT NOT NULL COMMENT '合同ID',
  `matched_clause` TEXT COMMENT '匹配的条款',
  `match_score` DECIMAL(5,2) COMMENT '匹配分数',
  `match_result` JSON COMMENT '匹配结果',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX `idx_task` (`review_task_id`),
  INDEX `idx_rule` (`rule_id`),
  INDEX `idx_contract` (`contract_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='规则匹配记录表';
```

### 3.5 条款识别模块

#### 3.5.1 合同条款表 (clauses_contract_clause)
```sql
CREATE TABLE `clauses_contract_clause` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `contract_id` BIGINT NOT NULL COMMENT '合同ID',
  `contract_version` INT COMMENT '合同版本号',
  `clause_no` VARCHAR(50) COMMENT '条款编号',
  `clause_type` VARCHAR(50) NOT NULL COMMENT '条款类型：party/subject/period/liability/payment',
  `clause_title` VARCHAR(500) COMMENT '条款标题',
  `clause_content` LONGTEXT NOT NULL COMMENT '条款内容',
  `start_position` INT COMMENT '起始位置',
  `end_position` INT COMMENT '结束位置',
  `extracted_data` JSON COMMENT '提取的结构化数据',
  `confidence` DECIMAL(5,2) COMMENT '识别置信度',
  `is_confirmed` BOOLEAN DEFAULT FALSE COMMENT '是否已确认',
  `confirmed_by` BIGINT COMMENT '确认人ID',
  `confirmed_at` DATETIME COMMENT '确认时间',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX `idx_contract` (`contract_id`),
  INDEX `idx_type` (`clause_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='合同条款表';
```

### 3.6 风险识别模块

#### 3.6.1 风险识别记录表 (risks_risk_identification)
```sql
CREATE TABLE `risks_risk_identification` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `review_result_id` BIGINT NOT NULL COMMENT '审核结果ID',
  `contract_id` BIGINT NOT NULL COMMENT '合同ID',
  `clause_id` BIGINT COMMENT '关联条款ID',
  `risk_type` VARCHAR(50) NOT NULL COMMENT '风险类型：invalid/missing/illegal/non_compliant',
  `risk_category` VARCHAR(50) COMMENT '风险分类：legality/compliance/completeness/financial',
  `risk_level` VARCHAR(20) NOT NULL COMMENT '风险等级：high/medium/low',
  `risk_description` TEXT NOT NULL COMMENT '风险描述',
  `risk_location` VARCHAR(200) COMMENT '风险位置',
  `legal_basis` TEXT COMMENT '法律依据',
  `suggestion` TEXT COMMENT '处理建议',
  `status` VARCHAR(50) DEFAULT 'pending' COMMENT '处理状态',
  `handled_by` BIGINT COMMENT '处理人ID',
  `handled_at` DATETIME COMMENT '处理时间',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX `idx_result` (`review_result_id`),
  INDEX `idx_contract` (`contract_id`),
  INDEX `idx_level` (`risk_level`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='风险识别记录表';
```

### 3.7 对比分析模块

#### 3.7.1 对比任务表 (comparisons_comparison_task)
```sql
CREATE TABLE `comparisons_comparison_task` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `task_type` VARCHAR(50) NOT NULL COMMENT '对比类型：version/template/cross_industry',
  `source_contract_id` BIGINT COMMENT '源合同ID',
  `target_contract_id` BIGINT COMMENT '目标合同ID',
  `source_version` INT COMMENT '源版本号',
  `target_version` INT COMMENT '目标版本号',
  `template_id` BIGINT COMMENT '模板ID（模板对比时）',
  `status` VARCHAR(50) DEFAULT 'pending' COMMENT '状态',
  `result_data` JSON COMMENT '对比结果数据',
  `created_by` BIGINT COMMENT '创建人ID',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `completed_at` DATETIME COMMENT '完成时间',
  INDEX `idx_source` (`source_contract_id`),
  INDEX `idx_target` (`target_contract_id`),
  INDEX `idx_type` (`task_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='对比任务表';
```

#### 3.7.2 对比差异表 (comparisons_comparison_diff)
```sql
CREATE TABLE `comparisons_comparison_diff` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `comparison_task_id` BIGINT NOT NULL COMMENT '对比任务ID',
  `diff_type` VARCHAR(50) NOT NULL COMMENT '差异类型：added/deleted/modified',
  `diff_level` VARCHAR(50) COMMENT '差异级别：clause/field/risk',
  `source_content` TEXT COMMENT '源内容',
  `target_content` TEXT COMMENT '目标内容',
  `clause_id` VARCHAR(100) COMMENT '条款ID',
  `risk_level` VARCHAR(20) COMMENT '风险等级',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX `idx_task` (`comparison_task_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='对比差异表';
```

### 3.8 知识图谱模块

#### 3.8.1 知识实体表 (knowledge_knowledge_entity)
```sql
CREATE TABLE `knowledge_knowledge_entity` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `entity_type` VARCHAR(50) NOT NULL COMMENT '实体类型：party/clause/regulation/case',
  `entity_name` VARCHAR(500) NOT NULL COMMENT '实体名称',
  `entity_code` VARCHAR(200) UNIQUE COMMENT '实体编码',
  `description` TEXT COMMENT '实体描述',
  `properties` JSON COMMENT '实体属性（JSON）',
  `source` VARCHAR(200) COMMENT '数据来源',
  `is_deleted` BOOLEAN DEFAULT FALSE,
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX `idx_type` (`entity_type`),
  INDEX `idx_code` (`entity_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='知识实体表';
```

#### 3.8.2 知识关系表 (knowledge_knowledge_relation)
```sql
CREATE TABLE `knowledge_knowledge_relation` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `source_entity_id` BIGINT NOT NULL COMMENT '源实体ID',
  `target_entity_id` BIGINT NOT NULL COMMENT '目标实体ID',
  `relation_type` VARCHAR(50) NOT NULL COMMENT '关系类型：legal_basis/related_to/similar_to',
  `relation_properties` JSON COMMENT '关系属性',
  `confidence` DECIMAL(5,2) COMMENT '关系置信度',
  `is_deleted` BOOLEAN DEFAULT FALSE,
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX `idx_source` (`source_entity_id`),
  INDEX `idx_target` (`target_entity_id`),
  INDEX `idx_relation` (`relation_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='知识关系表';
```

#### 3.8.3 法律法规表 (knowledge_regulation)
```sql
CREATE TABLE `knowledge_regulation` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `title` VARCHAR(500) NOT NULL COMMENT '法规标题',
  `regulation_no` VARCHAR(100) COMMENT '法规编号',
  `regulation_type` VARCHAR(50) COMMENT '法规类型：law/regulation/standard',
  `publish_date` DATE COMMENT '发布日期',
  `effective_date` DATE COMMENT '生效日期',
  `expiry_date` DATE COMMENT '失效日期',
  `content` LONGTEXT COMMENT '法规内容',
  `source_url` VARCHAR(500) COMMENT '来源URL',
  `entity_id` BIGINT COMMENT '关联实体ID',
  `is_active` BOOLEAN DEFAULT TRUE COMMENT '是否有效',
  `is_deleted` BOOLEAN DEFAULT FALSE,
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX `idx_no` (`regulation_no`),
  INDEX `idx_type` (`regulation_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='法律法规表';
```

#### 3.8.4 案例库表 (knowledge_case)
```sql
CREATE TABLE `knowledge_case` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `case_no` VARCHAR(100) COMMENT '案例编号',
  `case_title` VARCHAR(500) NOT NULL COMMENT '案例标题',
  `case_type` VARCHAR(50) COMMENT '案例类型',
  `court` VARCHAR(200) COMMENT '审理法院',
  `judge_date` DATE COMMENT '判决日期',
  `case_summary` TEXT COMMENT '案例摘要',
  `case_content` LONGTEXT COMMENT '案例内容',
  `related_clauses` JSON COMMENT '相关条款',
  `entity_id` BIGINT COMMENT '关联实体ID',
  `is_deleted` BOOLEAN DEFAULT FALSE,
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX `idx_no` (`case_no`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='案例库表';
```

### 3.9 智能推荐模块

#### 3.9.1 推荐记录表 (recommendations_recommendation)
```sql
CREATE TABLE `recommendations_recommendation` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  `contract_id` BIGINT COMMENT '合同ID',
  `recommendation_type` VARCHAR(50) NOT NULL COMMENT '推荐类型：clause/template/risk_response',
  `recommendation_context` VARCHAR(50) COMMENT '推荐场景：drafting/modifying/reviewing/negotiating',
  `item_type` VARCHAR(50) COMMENT '推荐项类型',
  `item_id` BIGINT COMMENT '推荐项ID',
  `item_content` TEXT COMMENT '推荐项内容',
  `score` DECIMAL(5,2) COMMENT '推荐分数',
  `reason` TEXT COMMENT '推荐理由',
  `is_accepted` BOOLEAN COMMENT '是否被接受',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX `idx_user` (`user_id`),
  INDEX `idx_type` (`recommendation_type`),
  INDEX `idx_contract` (`contract_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='推荐记录表';
```

## 4. 表关系说明

### 4.1 用户权限关系
- User ↔ Department (多对一)
- User ↔ Role (多对多，通过users_user_role)
- Role ↔ Permission (多对多，通过users_role_permission)

### 4.2 合同管理关系
- Contract ↔ User (起草人，多对一)
- Contract ↔ Template (多对一)
- Contract ↔ ContractVersion (一对多)
- User ↔ UserHabit (一对多)

### 4.3 审核关系
- Contract ↔ ReviewTask (一对多)
- ReviewTask ↔ ReviewResult (一对一)
- ReviewResult ↔ ReviewOpinion (一对多)
- ReviewResult ↔ RiskIdentification (一对多)
- Contract ↔ ReviewCycle (一对多)

### 4.4 规则引擎关系
- ReviewTask ↔ RuleMatch (一对多)
- RuleMatch ↔ ReviewRule (多对一)

### 4.5 条款识别关系
- Contract ↔ ContractClause (一对多)

### 4.6 知识图谱关系
- KnowledgeEntity ↔ KnowledgeRelation (自关联，多对多)

### 4.7 推荐关系
- User ↔ Recommendation (一对多)
- Contract ↔ Recommendation (一对多)

## 5. 索引设计

- 所有外键字段都建立索引
- 常用查询字段建立索引（如status, type, created_at等）
- 唯一性约束字段建立唯一索引

## 6. 数据安全

- 敏感数据（如密码）使用加密存储
- 使用软删除机制，保留历史数据
- 审计日志记录所有关键操作
- 支持数据加密（使用国密算法）

## 7. 性能优化建议

- 大文本字段（content）考虑使用文件存储或对象存储
- 历史数据定期归档
- 审核任务使用异步处理（Celery）
- 知识图谱数据考虑使用图数据库（如Neo4j）进行复杂查询

