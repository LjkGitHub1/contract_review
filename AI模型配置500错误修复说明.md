# AI模型配置500错误修复说明

## 问题描述

在创建AI模型配置时出现500内部服务器错误。

## 问题原因

1. **JSONField默认值问题**：Django的JSONField使用`default=list`会导致问题，应该使用可调用对象`lambda: []`
2. **序列化器验证问题**：`validate_default_model`方法在创建时可能无法正确获取`available_models`数据

## 修复内容

### 1. 修复JSONField默认值

**修改前：**
```python
available_models = models.JSONField(
    default=list,  # ❌ 错误：会导致所有实例共享同一个列表
    ...
)
```

**修改后：**
```python
available_models = models.JSONField(
    default=lambda: [],  # ✅ 正确：每次创建新实例时返回新列表
    ...
)
```

### 2. 修复序列化器验证

**修改前：**
```python
def validate_default_model(self, value):
    if value:
        available_models = self.initial_data.get('available_models', [])
        if available_models and value not in available_models:
            raise serializers.ValidationError('默认模型必须在可用模型列表中')
    return value
```

**修改后：**
```python
def validate(self, data):
    """验证默认模型是否在可用模型列表中"""
    available_models = data.get('available_models', [])
    default_model = data.get('default_model', '')
    
    if default_model and available_models:
        if default_model not in available_models:
            raise serializers.ValidationError({
                'default_model': '默认模型必须在可用模型列表中'
            })
    
    return data
```

## 解决步骤

1. **运行数据库迁移**（如果还没有运行）：
   ```bash
   cd backend
   python manage.py migrate
   ```

2. **如果迁移已运行但仍有问题**，可以尝试：
   ```bash
   # 重新生成迁移文件
   python manage.py makemigrations reviews
   
   # 运行迁移
   python manage.py migrate
   ```

3. **重启后端服务**：
   ```bash
   # 停止当前服务，然后重新启动
   python manage.py runserver 8897
   ```

## 验证修复

1. 访问AI模型配置页面：`http://localhost:5173/ai-model-config`
2. 点击"新建配置"
3. 填写配置信息：
   - 配置名称：测试配置
   - 服务提供商：硅基流动
   - API密钥：输入测试密钥
   - 选择模型：选择至少一个模型
   - 默认模型：从已选择的模型中选择
4. 点击"确定"，应该能成功创建配置

## 注意事项

1. **数据库迁移**：确保已运行最新的数据库迁移
2. **后端服务**：确保后端服务正常运行
3. **API密钥**：如果只是测试，可以使用任意字符串作为API密钥（后续可以测试连接）

---

**修复时间**：2024年12月22日

