# 403 Forbidden 错误修复指南

## 错误原因

403 Forbidden 错误通常由以下原因导致：
1. **文件权限问题** - Nginx 无法读取文件
2. **目录索引被禁用** - 缺少 index 文件或配置
3. **SELinux/AppArmor 安全策略** - 安全模块阻止访问
4. **Nginx 配置问题** - 访问限制或路径错误

## 解决方案

### 1. 检查文件权限（最重要）

```bash
# 检查前端文件是否存在
ls -la /www/wwwroot/contract_review/dist/36.134.27.102_5173/

# 检查 index.html 是否存在
ls -la /www/wwwroot/contract_review/dist/36.134.27.102_5173/index.html

# 如果文件不存在，重新构建前端
cd /www/wwwroot/contract_review/frontend
npm run build

# 修复文件权限（Nginx 用户通常是 www 或 www-data）
sudo chown -R www:www /www/wwwroot/contract_review/dist/
sudo chmod -R 755 /www/wwwroot/contract_review/dist/

# 确保 index.html 可读
sudo chmod 644 /www/wwwroot/contract_review/dist/36.134.27.102_5173/index.html
```

### 2. 检查 Nginx 配置

确保 Nginx 配置中包含：

```nginx
server {
    listen 8848;
    server_name 36.134.27.102;
    
    root /www/wwwroot/contract_review/dist/36.134.27.102_5173;
    index index.html index.htm;
    
    # 允许访问所有文件
    location / {
        try_files $uri $uri/ /index.html;
        index index.html;
    }
    
    # 如果使用宝塔面板，可能需要禁用目录浏览
    autoindex off;
}
```

### 3. 检查 Nginx 用户

```bash
# 查看 Nginx 运行用户
ps aux | grep nginx

# 查看 Nginx 配置文件中的用户设置
grep "user" /etc/nginx/nginx.conf

# 确保 Nginx 用户有权限读取文件
# 如果 Nginx 用户是 www，确保文件所有者是 www 或权限允许读取
```

### 4. 检查 SELinux（CentOS/RHEL）

```bash
# 检查 SELinux 状态
getenforce

# 如果返回 Enforcing，需要设置 SELinux 上下文
sudo chcon -R -t httpd_sys_content_t /www/wwwroot/contract_review/dist/
sudo chcon -R -t httpd_sys_rw_content_t /www/wwwroot/contract_review/dist/

# 或者临时禁用 SELinux（不推荐，仅用于测试）
sudo setenforce 0
```

### 5. 检查目录结构

```bash
# 确保目录结构正确
ls -la /www/wwwroot/contract_review/dist/36.134.27.102_5173/

# 应该看到类似以下内容：
# - index.html
# - assets/
# - favicon.ico
# 等文件
```

### 6. 检查 Nginx 错误日志

```bash
# 查看详细错误信息
tail -50 /www/wwwlogs/36.134.27.102_5173.error.log

# 常见错误信息：
# - "directory index of ... is forbidden" - 缺少 index 文件
# - "open() ... failed (13: Permission denied)" - 权限问题
# - "access forbidden by rule" - 访问规则限制
```

### 7. 测试配置

```bash
# 测试 Nginx 配置
sudo nginx -t

# 重新加载 Nginx
sudo systemctl reload nginx
# 或
sudo nginx -s reload
```

### 8. 完整修复脚本

```bash
#!/bin/bash
# 一键修复 403 错误

# 1. 重新构建前端
cd /www/wwwroot/contract_review/frontend
npm run build

# 2. 修复权限
sudo chown -R www:www /www/wwwroot/contract_review/dist/
sudo chmod -R 755 /www/wwwroot/contract_review/dist/
sudo find /www/wwwroot/contract_review/dist/ -type f -exec chmod 644 {} \;
sudo find /www/wwwroot/contract_review/dist/ -type d -exec chmod 755 {} \;

# 3. 检查文件
ls -la /www/wwwroot/contract_review/dist/36.134.27.102_5173/index.html

# 4. 测试 Nginx
sudo nginx -t

# 5. 重新加载
sudo systemctl reload nginx

echo "修复完成，请测试访问 http://36.134.27.102:8848"
```

## 宝塔面板特殊处理

如果使用宝塔面板：

1. **在面板中设置**：
   - 网站 → 选择站点 → 网站目录
   - 确保"运行目录"设置为 `/`
   - 确保"防跨站攻击"已关闭（或正确配置）

2. **检查面板权限**：
   - 文件 → 找到 dist 目录 → 右键 → 权限
   - 设置为 755（目录）和 644（文件）

3. **重新加载配置**：
   - 网站 → 选择站点 → 设置 → 配置文件
   - 保存后点击"重载配置"

## 验证修复

修复后，测试访问：

```bash
# 测试本地访问
curl http://localhost:8848

# 应该返回 HTML 内容，而不是 403 错误

# 测试外部访问
curl http://36.134.27.102:8848
```

## 常见错误日志及解决方案

### 错误1: "directory index of ... is forbidden"
**原因**：缺少 index.html 文件
**解决**：重新构建前端或检查构建路径

### 错误2: "open() ... failed (13: Permission denied)"
**原因**：文件权限不足
**解决**：修复文件权限（见步骤1）

### 错误3: "access forbidden by rule"
**原因**：Nginx 配置中有访问限制
**解决**：检查 location 块中是否有 deny 规则

### 错误4: "client denied by server configuration"
**原因**：Nginx 配置问题
**解决**：检查 server 块配置，确保没有错误的访问限制

