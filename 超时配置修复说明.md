# AI生成超时问题修复说明

## 问题描述

AI生成合同内容时出现超时错误，即使已经将前端超时时间增加到120秒，仍然超时。

## 根本原因

超时问题不仅仅在前端，整个请求链路中有多个超时设置：
1. **前端Axios超时**：30秒 → 180秒 ✅
2. **Nginx代理超时**：60秒 → 300秒 ✅
3. **Gunicorn超时**：120秒 → 300秒 ✅
4. **后端AI API调用超时**：30秒 → 240秒 ✅

## 已修复的配置

### 1. 前端超时设置
- **文件**: `frontend/src/views/contracts/ContractCreate.vue`
- **修改**: AI生成请求超时时间从120秒增加到180秒（3分钟）
- **提示**: 更新用户提示为"可能需要2-3分钟"

### 2. 后端AI调用超时
- **文件**: `backend/apps/contracts/services.py`
- **修改**: AI API调用超时时间从180秒增加到240秒（4分钟）

### 3. Nginx代理超时（关键修复）
- **文件**: 
  - `frontend/nginx.conf` (Docker部署)
  - `nginx_8848配置示例.conf` (服务器部署)
- **修改**: 
  - `proxy_send_timeout`: 60秒 → 300秒（5分钟）
  - `proxy_read_timeout`: 60秒 → 300秒（5分钟）
- **说明**: 这是关键修复，Nginx的60秒超时是导致问题的根本原因

### 4. Gunicorn超时
- **文件**: 
  - `docker-compose.yml`
  - `docker-compose.prod.yml`
- **修改**: Gunicorn超时时间从120秒增加到300秒（5分钟）

## 超时时间链

现在的超时时间链（从长到短）：
1. **Nginx**: 300秒（5分钟）
2. **Gunicorn**: 300秒（5分钟）
3. **后端AI调用**: 240秒（4分钟）
4. **前端Axios**: 180秒（3分钟）

这样确保整个链路都有足够的超时时间。

## 部署后需要做的操作

### 如果使用Docker部署

```bash
# 重新构建并启动
docker-compose down
docker-compose build
docker-compose up -d
```

### 如果使用Nginx服务器部署

1. **更新Nginx配置**：
   - 编辑Nginx配置文件（如 `nginx_8848配置示例.conf`）
   - 修改 `proxy_send_timeout` 和 `proxy_read_timeout` 为 300s
   - 测试配置：`sudo nginx -t`
   - 重新加载：`sudo nginx -s reload` 或 `sudo systemctl reload nginx`

2. **更新Gunicorn配置**（如果使用systemd）：
   - 编辑Gunicorn服务文件
   - 修改 `--timeout` 参数为 300
   - 重启服务：`sudo systemctl restart gunicorn`

### 如果使用开发服务器

开发服务器（`python manage.py runserver`）通常没有超时限制，但建议：
- 确保AI模型配置中的超时时间至少为240秒
- 检查网络连接和AI API服务状态

## 验证修复

修复后，测试AI生成功能：
1. 填写合同基本信息
2. 点击"AI生成合同内容"
3. 应该能够成功生成，即使需要2-3分钟也不会超时

## 如果仍然超时

如果修复后仍然超时，可能的原因：
1. **AI API服务本身响应慢**：检查AI服务商的状态和响应时间
2. **网络问题**：检查服务器到AI API的网络连接
3. **AI模型配置问题**：检查AI模型配置中的超时设置
4. **合同内容过长**：如果合同内容特别长，可能需要进一步增加超时时间

## 进一步优化建议

如果AI生成仍然很慢，可以考虑：
1. **异步处理**：将AI生成改为异步任务，使用Celery处理
2. **流式输出**：如果AI API支持，使用流式输出，边生成边显示
3. **优化提示词**：减少提示词长度，加快AI响应速度
4. **使用更快的AI模型**：选择响应更快的AI模型

## 相关文件

- `frontend/src/views/contracts/ContractCreate.vue` - 前端超时设置
- `backend/apps/contracts/services.py` - 后端AI调用超时
- `frontend/nginx.conf` - Docker Nginx配置
- `nginx_8848配置示例.conf` - 服务器Nginx配置
- `docker-compose.yml` - Docker Gunicorn配置
- `docker-compose.prod.yml` - 生产环境Gunicorn配置

