# 8848端口部署排查指南

## 问题：访问不到8848端口

### 1. 检查Nginx配置

#### 确认配置文件位置
- 宝塔面板：`/www/server/panel/vhost/nginx/36.134.27.102_5173.conf`
- 标准Nginx：`/etc/nginx/sites-available/` 或 `/etc/nginx/conf.d/`

#### 检查配置内容
确保包含以下关键配置：

```nginx
server {
    listen 8848;
    server_name 36.134.27.102;
    
    root /www/wwwroot/contract_review/dist/36.134.27.102_5173;
    
    # 前端路由支持（重要！）
    location / {
        try_files $uri $uri/ /index.html;
        index index.html;
    }
    
    # API代理（重要！）
    location /api {
        proxy_pass http://127.0.0.1:8897;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

### 2. 检查前端构建

```bash
# 进入前端目录
cd /www/wwwroot/contract_review/frontend

# 检查是否已构建
ls -la dist/

# 如果没有构建，执行构建
npm install
npm run build

# 检查构建产物是否在正确位置
ls -la /www/wwwroot/contract_review/dist/36.134.27.102_5173/
```

### 3. 检查后端服务

```bash
# 检查Django服务是否运行在8897端口
netstat -tlnp | grep 8897
# 或
ss -tlnp | grep 8897

# 如果没有运行，启动服务
cd /www/wwwroot/contract_review/backend
source venv/bin/activate  # 如果有虚拟环境
python manage.py runserver 0.0.0.0:8897

# 或者使用Gunicorn（生产环境推荐）
gunicorn config.wsgi:application --bind 0.0.0.0:8897 --workers 4
```

### 4. 检查防火墙

```bash
# 检查防火墙状态
# Ubuntu/Debian
sudo ufw status
sudo ufw allow 8848/tcp

# CentOS/RHEL
sudo firewall-cmd --list-all
sudo firewall-cmd --permanent --add-port=8848/tcp
sudo firewall-cmd --reload

# 云服务器（阿里云/腾讯云等）
# 需要在云控制台的安全组中开放8848端口
```

### 5. 检查Nginx服务状态

```bash
# 测试Nginx配置
sudo nginx -t

# 如果使用宝塔面板
# 在面板中点击"测试配置"

# 重新加载Nginx
sudo systemctl reload nginx
# 或
sudo nginx -s reload

# 检查Nginx是否监听8848端口
sudo netstat -tlnp | grep 8848
# 或
sudo ss -tlnp | grep 8848
```

### 6. 检查文件权限

```bash
# 检查前端文件权限
ls -la /www/wwwroot/contract_review/dist/36.134.27.102_5173/

# 确保Nginx可以读取文件
sudo chown -R www:www /www/wwwroot/contract_review/dist/
sudo chmod -R 755 /www/wwwroot/contract_review/dist/
```

### 7. 检查日志

```bash
# Nginx错误日志
tail -f /www/wwwlogs/36.134.27.102_5173.error.log

# Nginx访问日志
tail -f /www/wwwlogs/36.134.27.102_5173.log

# Django日志（如果有）
tail -f /www/wwwroot/contract_review/backend/logs/error.log
```

### 8. 测试步骤

#### 步骤1：测试Nginx配置
```bash
sudo nginx -t
```

#### 步骤2：测试本地访问
```bash
# 在服务器上测试
curl http://localhost:8848
curl http://127.0.0.1:8848
```

#### 步骤3：测试API代理
```bash
# 测试API是否正常
curl http://localhost:8848/api/users/users/me/
```

#### 步骤4：测试外部访问
```bash
# 从外部测试（替换为实际IP）
curl http://36.134.27.102:8848
```

### 9. 常见问题及解决方案

#### 问题1：502 Bad Gateway
**原因**：后端服务未运行或端口不对
**解决**：
```bash
# 检查后端服务
ps aux | grep gunicorn
ps aux | grep manage.py

# 启动后端服务
cd /www/wwwroot/contract_review/backend
source venv/bin/activate
gunicorn config.wsgi:application --bind 0.0.0.0:8897 --workers 4
```

#### 问题2：404 Not Found
**原因**：前端文件路径不对或未构建
**解决**：
```bash
# 检查文件是否存在
ls -la /www/wwwroot/contract_review/dist/36.134.27.102_5173/index.html

# 重新构建前端
cd /www/wwwroot/contract_review/frontend
npm run build
```

#### 问题3：空白页面
**原因**：缺少 `try_files` 配置，SPA路由无法工作
**解决**：在Nginx配置中添加：
```nginx
location / {
    try_files $uri $uri/ /index.html;
}
```

#### 问题4：API请求失败
**原因**：缺少API代理配置
**解决**：在Nginx配置中添加：
```nginx
location /api {
    proxy_pass http://127.0.0.1:8897;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}
```

#### 问题5：端口被占用
**原因**：8848端口被其他服务占用
**解决**：
```bash
# 检查端口占用
sudo lsof -i :8848
# 或
sudo netstat -tlnp | grep 8848

# 停止占用端口的服务或更换端口
```

### 10. 完整部署检查清单

- [ ] 前端已构建（`npm run build`）
- [ ] 构建产物在正确目录（`/www/wwwroot/contract_review/dist/36.134.27.102_5173/`）
- [ ] 后端服务运行在8897端口
- [ ] Nginx配置包含前端路由支持（`try_files`）
- [ ] Nginx配置包含API代理（`location /api`）
- [ ] Nginx配置测试通过（`nginx -t`）
- [ ] Nginx已重新加载（`systemctl reload nginx`）
- [ ] 防火墙已开放8848端口
- [ ] 云服务器安全组已开放8848端口
- [ ] 文件权限正确（Nginx用户可以读取）
- [ ] 可以本地访问（`curl http://localhost:8848`）
- [ ] 可以外部访问（`curl http://36.134.27.102:8848`）

### 11. 快速修复命令

```bash
# 1. 重新构建前端
cd /www/wwwroot/contract_review/frontend
npm run build

# 2. 检查后端服务
cd /www/wwwroot/contract_review/backend
source venv/bin/activate
python manage.py runserver 0.0.0.0:8897 &
# 或使用Gunicorn
gunicorn config.wsgi:application --bind 0.0.0.0:8897 --workers 4 &

# 3. 测试Nginx配置
sudo nginx -t

# 4. 重新加载Nginx
sudo systemctl reload nginx

# 5. 检查端口监听
sudo netstat -tlnp | grep -E '8848|8897'

# 6. 查看日志
tail -f /www/wwwlogs/36.134.27.102_5173.error.log
```

### 12. 宝塔面板特殊说明

如果使用宝塔面板：

1. **在面板中配置**：
   - 网站 → 添加站点 → 设置端口8848
   - 网站设置 → 配置文件 → 添加API代理配置

2. **手动编辑配置**：
   - 配置文件位置：`/www/server/panel/vhost/nginx/36.134.27.102_5173.conf`
   - 编辑后点击"保存"和"重载配置"

3. **检查服务**：
   - 软件商店 → 运行环境 → Nginx → 设置 → 重载配置

### 13. 测试访问

访问以下URL测试：

1. **前端页面**：`http://36.134.27.102:8848`
2. **API测试**：`http://36.134.27.102:8848/api/users/users/me/`（需要登录）
3. **健康检查**：`http://36.134.27.102:8848/api/`（如果有健康检查端点）

如果以上都正常，但浏览器访问不到，可能是：
- 浏览器缓存问题（清除缓存或使用无痕模式）
- DNS解析问题（直接使用IP访问）
- 网络问题（检查网络连接）

