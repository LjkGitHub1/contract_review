# AI智能合同审核系统 - 服务器部署文档

## 目录
1. [部署概述](#部署概述)
2. [服务器环境准备](#服务器环境准备)
3. [数据库配置](#数据库配置)
4. [后端部署](#后端部署)
5. [前端部署](#前端部署)
6. [Nginx配置](#nginx配置)
7. [进程管理](#进程管理)
8. [安全配置](#安全配置)
9. [监控与日志](#监控与日志)
10. [常见问题排查](#常见问题排查)

---

## 部署概述

### 系统架构
- **后端**: Django 5.0.1 + MySQL + Redis + Celery
- **前端**: Vue 3 + Vite
- **Web服务器**: Nginx
- **进程管理**: systemd (Linux) 或 Supervisor

### 部署架构图
```
用户请求
   ↓
Nginx (80/443端口)
   ↓
   ├─→ 静态文件 (前端构建产物)
   └─→ /api → Gunicorn/uWSGI (Django后端)
              ↓
           MySQL数据库
           Redis (Celery队列)
```

### 服务器要求
- **操作系统**: Ubuntu 20.04+ / CentOS 7+ / Debian 10+
- **CPU**: 4核心+
- **内存**: 8GB RAM+
- **磁盘**: 50GB+ 可用空间 (SSD推荐)
- **网络**: 公网IP + 域名（可选但推荐）

---

## 服务器环境准备

### 1. 更新系统
```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y

# CentOS/RHEL
sudo yum update -y
```

### 2. 安装基础工具
```bash
# Ubuntu/Debian
sudo apt install -y git curl wget vim build-essential

# CentOS/RHEL
sudo yum install -y git curl wget vim gcc gcc-c++ make
```

### 3. 安装Python 3.10+
```bash
# Ubuntu/Debian
sudo apt install -y python3.10 python3.10-venv python3-pip python3-dev

# CentOS/RHEL (需要EPEL仓库)
sudo yum install -y epel-release
sudo yum install -y python310 python310-pip python310-devel

# 验证安装
python3 --version
pip3 --version
```

### 4. 安装MySQL 8.0+
```bash
# Ubuntu/Debian
sudo apt install -y mysql-server mysql-client

# CentOS/RHEL
sudo yum install -y mysql-server mysql

# 启动MySQL服务
sudo systemctl start mysql
sudo systemctl enable mysql

# 安全配置（设置root密码）
sudo mysql_secure_installation
```

### 5. 安装Redis
```bash
# Ubuntu/Debian
sudo apt install -y redis-server

# CentOS/RHEL
sudo yum install -y redis

# 启动Redis服务
sudo systemctl start redis
sudo systemctl enable redis

# 验证Redis
redis-cli ping
# 应返回: PONG
```

### 6. 安装Node.js 18 LTS
```bash
# 使用NodeSource仓库
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

# 验证安装
node --version
npm --version
```

### 7. 安装Nginx
```bash
# Ubuntu/Debian
sudo apt install -y nginx

# CentOS/RHEL
sudo yum install -y nginx

# 启动Nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

### 8. 安装Gunicorn（用于生产环境运行Django）
```bash
# 稍后在虚拟环境中安装，这里先记录
# pip install gunicorn
```

---

## 数据库配置

### 1. 创建数据库和用户
```bash
# 登录MySQL
sudo mysql -u root -p

# 在MySQL命令行中执行
CREATE DATABASE contract_review CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'contract_user'@'localhost' IDENTIFIED BY 'your_strong_password_here';
GRANT ALL PRIVILEGES ON contract_review.* TO 'contract_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

### 2. 配置MySQL（可选优化）
编辑 `/etc/mysql/mysql.conf.d/mysqld.cnf` (Ubuntu) 或 `/etc/my.cnf` (CentOS):
```ini
[mysqld]
character-set-server=utf8mb4
collation-server=utf8mb4_unicode_ci
max_connections=200
innodb_buffer_pool_size=2G
```

重启MySQL:
```bash
sudo systemctl restart mysql
```

---

## 后端部署

### 1. 创建项目目录
```bash
# 创建项目目录
sudo mkdir -p /var/www/contract-review
sudo chown $USER:$USER /var/www/contract-review
cd /var/www/contract-review
```

### 2. 上传项目代码
```bash
# 方式1: 使用Git克隆
git clone <your-repository-url> .

# 方式2: 使用SCP上传
# 在本地执行: scp -r /path/to/project user@server:/var/www/contract-review/
```

### 3. 创建Python虚拟环境
```bash
cd /var/www/contract-review/backend
python3 -m venv venv
source venv/bin/activate  # 激活虚拟环境
```

### 4. 安装Python依赖
```bash
# 升级pip
pip install --upgrade pip

# 安装依赖（如果网络慢，可使用国内镜像）
pip install -r requirements.txt
# 或使用镜像: pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# 安装Gunicorn（生产环境WSGI服务器）
pip install gunicorn
```

### 5. 配置环境变量
```bash
cd /var/www/contract-review/backend
cp .env.example .env  # 如果有示例文件
# 或直接创建
nano .env
```

在 `.env` 文件中配置：
```env
# Django配置
SECRET_KEY=your-very-long-random-secret-key-here-generate-with-openssl
DEBUG=False
ALLOWED_HOSTS=your-domain.com,www.your-domain.com,server-ip

# 数据库配置
DB_NAME=contract_review
DB_USER=contract_user
DB_PASSWORD=your_strong_password_here
DB_HOST=localhost
DB_PORT=3306

# Celery配置
CELERY_BROKER_URL=redis://localhost:6379/0
CELERY_RESULT_BACKEND=redis://localhost:6379/0
```

生成SECRET_KEY:
```bash
python -c "from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())"
```

### 6. 运行数据库迁移
```bash
cd /var/www/contract-review/backend
source venv/bin/activate
python manage.py migrate
```

### 7. 创建超级用户
```bash
python manage.py createsuperuser
```

### 8. 收集静态文件
```bash
python manage.py collectstatic --noinput
```

### 9. 测试Django运行
```bash
# 使用Gunicorn测试
gunicorn config.wsgi:application --bind 0.0.0.0:8897 --workers 4

# 在另一个终端测试
curl http://localhost:8897/api/
```

---

## 前端部署

### 1. 安装前端依赖
```bash
cd /var/www/contract-review/frontend
npm install

# 如果网络慢，可使用国内镜像
npm config set registry https://registry.npmmirror.com
npm install
```

### 2. 配置API地址
编辑 `frontend/src/utils/api.js`，修改baseURL为生产环境API地址：
```javascript
const api = axios.create({
  baseURL: 'https://your-domain.com/api',  // 或 'http://your-server-ip/api'
  timeout: 30000,
})
```

或者使用环境变量（推荐）：
创建 `frontend/.env.production`:
```env
VITE_API_BASE_URL=https://your-domain.com/api
```

修改 `frontend/src/utils/api.js`:
```javascript
const api = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL || '/api',
  timeout: 30000,
})
```

### 3. 构建生产版本
```bash
cd /var/www/contract-review/frontend
npm run build
```

构建产物将生成在 `frontend/dist` 目录。

### 4. 测试构建产物
```bash
# 使用简单HTTP服务器测试
cd dist
python3 -m http.server 8080
# 访问 http://server-ip:8080 测试
```

---

## Nginx配置

### 1. 创建Nginx配置文件
```bash
sudo nano /etc/nginx/sites-available/contract-review
```

### 2. Nginx配置内容
```nginx
# 上游服务器配置（Django后端）
upstream django_backend {
    server 127.0.0.1:8897;
    # 如果有多个worker，可以添加多个server实现负载均衡
    # server 127.0.0.1:8898;
}

# HTTP服务器配置
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;
    
    # 重定向到HTTPS（如果配置了SSL）
    # return 301 https://$server_name$request_uri;
    
    # 如果没有SSL，直接使用HTTP配置
    client_max_body_size 20M;  # 允许上传20MB文件
    
    # 前端静态文件
    location / {
        root /var/www/contract-review/frontend/dist;
        try_files $uri $uri/ /index.html;
        index index.html;
    }
    
    # 后端API
    location /api {
        proxy_pass http://django_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
        
        # WebSocket支持（如果需要）
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    # 媒体文件（上传的文件）
    location /media {
        alias /var/www/contract-review/backend/media;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # 静态文件（Django collectstatic收集的文件）
    location /static {
        alias /var/www/contract-review/backend/staticfiles;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # 日志
    access_log /var/log/nginx/contract-review-access.log;
    error_log /var/log/nginx/contract-review-error.log;
}

# HTTPS配置（推荐，需要SSL证书）
# server {
#     listen 443 ssl http2;
#     server_name your-domain.com www.your-domain.com;
#     
#     ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
#     
#     client_max_body_size 20M;
#     
#     location / {
#         root /var/www/contract-review/frontend/dist;
#         try_files $uri $uri/ /index.html;
#         index index.html;
#     }
#     
#     location /api {
#         proxy_pass http://django_backend;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_redirect off;
#     }
#     
#     location /media {
#         alias /var/www/contract-review/backend/media;
#         expires 30d;
#     }
#     
#     location /static {
#         alias /var/www/contract-review/backend/staticfiles;
#         expires 30d;
#     }
#     
#     access_log /var/log/nginx/contract-review-access.log;
#     error_log /var/log/nginx/contract-review-error.log;
# }
```

### 3. 启用配置
```bash
# 创建符号链接
sudo ln -s /etc/nginx/sites-available/contract-review /etc/nginx/sites-enabled/

# 删除默认配置（可选）
sudo rm /etc/nginx/sites-enabled/default

# 测试Nginx配置
sudo nginx -t

# 重新加载Nginx
sudo systemctl reload nginx
```

### 4. 配置SSL证书（推荐，使用Let's Encrypt）
```bash
# 安装Certbot
sudo apt install -y certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d your-domain.com -d www.your-domain.com

# 自动续期测试
sudo certbot renew --dry-run
```

---

## 进程管理

### 使用systemd管理服务

#### 1. 创建Gunicorn服务
```bash
sudo nano /etc/systemd/system/contract-review.service
```

内容：
```ini
[Unit]
Description=Contract Review Django Application
After=network.target mysql.service redis.service

[Service]
Type=notify
User=www-data
Group=www-data
WorkingDirectory=/var/www/contract-review/backend
Environment="PATH=/var/www/contract-review/backend/venv/bin"
ExecStart=/var/www/contract-review/backend/venv/bin/gunicorn \
    --workers 4 \
    --worker-class sync \
    --bind 127.0.0.1:8897 \
    --timeout 120 \
    --access-logfile /var/log/contract-review/access.log \
    --error-logfile /var/log/contract-review/error.log \
    config.wsgi:application

Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

#### 2. 创建Celery Worker服务
```bash
sudo nano /etc/systemd/system/contract-review-celery.service
```

内容：
```ini
[Unit]
Description=Contract Review Celery Worker
After=network.target redis.service

[Service]
Type=forking
User=www-data
Group=www-data
WorkingDirectory=/var/www/contract-review/backend
Environment="PATH=/var/www/contract-review/backend/venv/bin"
ExecStart=/var/www/contract-review/backend/venv/bin/celery \
    -A config worker \
    --loglevel=info \
    --logfile=/var/log/contract-review/celery.log \
    --pidfile=/var/run/contract-review/celery.pid \
    --detach

ExecStop=/bin/kill -s TERM $MAINPID
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

#### 3. 创建Celery Beat服务（如果需要定时任务）
```bash
sudo nano /etc/systemd/system/contract-review-celery-beat.service
```

内容：
```ini
[Unit]
Description=Contract Review Celery Beat
After=network.target redis.service

[Service]
Type=forking
User=www-data
Group=www-data
WorkingDirectory=/var/www/contract-review/backend
Environment="PATH=/var/www/contract-review/backend/venv/bin"
ExecStart=/var/www/contract-review/backend/venv/bin/celery \
    -A config beat \
    --loglevel=info \
    --logfile=/var/log/contract-review/celery-beat.log \
    --pidfile=/var/run/contract-review/celery-beat.pid \
    --detach

ExecStop=/bin/kill -s TERM $MAINPID
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

#### 4. 创建必要的目录和设置权限
```bash
# 创建日志目录
sudo mkdir -p /var/log/contract-review
sudo mkdir -p /var/run/contract-review

# 设置权限
sudo chown -R www-data:www-data /var/www/contract-review
sudo chown -R www-data:www-data /var/log/contract-review
sudo chown -R www-data:www-data /var/run/contract-review

# 设置项目目录权限
sudo chmod -R 755 /var/www/contract-review
```

#### 5. 启动和管理服务
```bash
# 重新加载systemd配置
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start contract-review
sudo systemctl start contract-review-celery
# sudo systemctl start contract-review-celery-beat  # 如果需要

# 设置开机自启
sudo systemctl enable contract-review
sudo systemctl enable contract-review-celery
# sudo systemctl enable contract-review-celery-beat  # 如果需要

# 查看服务状态
sudo systemctl status contract-review
sudo systemctl status contract-review-celery

# 查看日志
sudo journalctl -u contract-review -f
sudo journalctl -u contract-review-celery -f

# 重启服务
sudo systemctl restart contract-review
sudo systemctl restart contract-review-celery

# 停止服务
sudo systemctl stop contract-review
sudo systemctl stop contract-review-celery
```

---

## 安全配置

### 1. 防火墙配置
```bash
# Ubuntu/Debian (UFW)
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw enable

# CentOS/RHEL (firewalld)
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

### 2. Django安全设置检查
确保 `backend/config/settings.py` 中：
- `DEBUG = False`
- `ALLOWED_HOSTS` 包含域名和IP
- `SECRET_KEY` 使用强随机密钥
- 使用HTTPS（生产环境）

### 3. 数据库安全
- 使用强密码
- 限制数据库用户权限
- 只允许本地连接

### 4. 文件权限
```bash
# 确保敏感文件权限正确
chmod 600 /var/www/contract-review/backend/.env
chmod 755 /var/www/contract-review/backend
```

### 5. 定期备份
创建备份脚本 `/var/www/contract-review/backup.sh`:
```bash
#!/bin/bash
BACKUP_DIR="/var/backups/contract-review"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# 备份数据库
mysqldump -u contract_user -p'your_password' contract_review > $BACKUP_DIR/db_$DATE.sql

# 备份媒体文件
tar -czf $BACKUP_DIR/media_$DATE.tar.gz /var/www/contract-review/backend/media

# 删除7天前的备份
find $BACKUP_DIR -type f -mtime +7 -delete

echo "Backup completed: $DATE"
```

设置定时任务：
```bash
chmod +x /var/www/contract-review/backup.sh
crontab -e
# 添加: 0 2 * * * /var/www/contract-review/backup.sh
```

---

## 监控与日志

### 1. 日志位置
- **Django日志**: `/var/log/contract-review/error.log`
- **Gunicorn访问日志**: `/var/log/contract-review/access.log`
- **Celery日志**: `/var/log/contract-review/celery.log`
- **Nginx日志**: `/var/log/nginx/contract-review-*.log`

### 2. 日志轮转
创建 `/etc/logrotate.d/contract-review`:
```
/var/log/contract-review/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 www-data www-data
    sharedscripts
    postrotate
        systemctl reload contract-review > /dev/null 2>&1 || true
    endscript
}
```

### 3. 监控服务状态
```bash
# 检查所有服务状态
sudo systemctl status contract-review
sudo systemctl status contract-review-celery
sudo systemctl status nginx
sudo systemctl status mysql
sudo systemctl status redis

# 检查端口监听
sudo netstat -tlnp | grep -E '8897|6379|3306|80|443'
```

### 4. 性能监控
```bash
# 安装监控工具
sudo apt install -y htop iotop

# 查看系统资源
htop
df -h  # 磁盘使用
free -h  # 内存使用
```

---

## 常见问题排查

### 1. 502 Bad Gateway
**原因**: Gunicorn服务未运行或配置错误
**解决**:
```bash
# 检查Gunicorn服务
sudo systemctl status contract-review

# 查看错误日志
sudo journalctl -u contract-review -n 50

# 检查端口是否监听
sudo netstat -tlnp | grep 8897
```

### 2. 静态文件404
**原因**: 静态文件未收集或Nginx配置错误
**解决**:
```bash
# 重新收集静态文件
cd /var/www/contract-review/backend
source venv/bin/activate
python manage.py collectstatic --noinput

# 检查Nginx配置
sudo nginx -t
sudo systemctl reload nginx
```

### 3. 数据库连接失败
**原因**: 数据库服务未运行或配置错误
**解决**:
```bash
# 检查MySQL服务
sudo systemctl status mysql

# 测试数据库连接
mysql -u contract_user -p contract_review

# 检查.env文件配置
cat /var/www/contract-review/backend/.env | grep DB_
```

### 4. Redis连接失败
**原因**: Redis服务未运行
**解决**:
```bash
# 检查Redis服务
sudo systemctl status redis
redis-cli ping

# 重启Redis
sudo systemctl restart redis
```

### 5. Celery任务不执行
**原因**: Celery Worker未运行
**解决**:
```bash
# 检查Celery服务
sudo systemctl status contract-review-celery

# 查看Celery日志
tail -f /var/log/contract-review/celery.log

# 重启Celery
sudo systemctl restart contract-review-celery
```

### 6. 权限错误
**原因**: 文件或目录权限不正确
**解决**:
```bash
# 修复权限
sudo chown -R www-data:www-data /var/www/contract-review
sudo chmod -R 755 /var/www/contract-review
sudo chmod 600 /var/www/contract-review/backend/.env
```

### 7. 前端API请求失败
**原因**: API地址配置错误或CORS问题
**解决**:
- 检查 `frontend/src/utils/api.js` 中的baseURL
- 检查Django的 `CORS_ALLOWED_ORIGINS` 设置
- 检查Nginx代理配置

---

## 部署检查清单

部署完成后，请检查以下项目：

- [ ] 所有服务正常运行（Django, Celery, Nginx, MySQL, Redis）
- [ ] 前端页面可以正常访问
- [ ] API接口可以正常调用
- [ ] 数据库连接正常
- [ ] 文件上传功能正常
- [ ] Celery异步任务可以执行
- [ ] 日志文件正常生成
- [ ] SSL证书配置（如果使用HTTPS）
- [ ] 防火墙规则配置
- [ ] 备份脚本配置
- [ ] 监控和告警配置（可选）

---

## 更新部署

### 更新代码
```bash
cd /var/www/contract-review

# 拉取最新代码
git pull origin main  # 或你的分支名

# 更新后端依赖
cd backend
source venv/bin/activate
pip install -r requirements.txt

# 运行数据库迁移
python manage.py migrate

# 收集静态文件
python manage.py collectstatic --noinput

# 重启服务
sudo systemctl restart contract-review
sudo systemctl restart contract-review-celery

# 更新前端
cd ../frontend
npm install
npm run build

# 重新加载Nginx
sudo systemctl reload nginx
```

---

## 联系与支持

如遇到部署问题，请检查：
1. 日志文件
2. 服务状态
3. 网络连接
4. 配置文件

---

**文档版本**: 1.0  
**最后更新**: 2024年12月

