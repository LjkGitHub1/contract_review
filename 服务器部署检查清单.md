# 服务器部署检查清单

使用此清单确保部署过程完整无误。

## 部署前准备

### 服务器要求
- [ ] 服务器操作系统：Ubuntu 20.04+ / CentOS 7+ / Debian 10+
- [ ] CPU：至少2核心（推荐4核心+）
- [ ] 内存：至少4GB（推荐8GB+）
- [ ] 磁盘空间：至少20GB可用（推荐50GB+）
- [ ] 网络：可访问互联网（用于下载Docker镜像）

### 软件要求
- [ ] Docker Engine 20.10+
- [ ] Docker Compose 2.0+
- [ ] Git（如果使用Git部署）

### 网络配置
- [ ] 端口80已开放（前端）
- [ ] 端口443已开放（HTTPS，可选）
- [ ] 端口8000已开放（后端API，可选）
- [ ] 防火墙规则已配置

## 部署步骤

### 1. 安装Docker
- [ ] 已安装Docker Engine
- [ ] 已安装Docker Compose
- [ ] Docker服务已启动并设置为开机自启
- [ ] 当前用户已添加到docker组（可选）

### 2. 上传项目
- [ ] 项目文件已上传到服务器（如 `/opt/contract_review`）
- [ ] 项目目录权限正确
- [ ] 已进入项目目录

### 3. 配置环境变量
- [ ] 已复制 `.env.example` 到 `.env`
- [ ] 已修改 `SECRET_KEY`（强密钥，至少50字符）
- [ ] 已修改 `DB_PASSWORD`（强密码）
- [ ] 已修改 `DB_ROOT_PASSWORD`（强密码）
- [ ] 已配置 `CORS_ALLOWED_ORIGINS`（实际域名）
- [ ] 已检查其他环境变量配置

### 4. 构建和启动
- [ ] 已执行 `docker compose build`
- [ ] 构建成功，无错误
- [ ] 已执行 `docker compose up -d`
- [ ] 所有服务状态为 "Up"

### 5. 初始化数据库
- [ ] 已等待数据库完全启动（至少30秒）
- [ ] 已执行数据库迁移：`docker compose exec backend python manage.py migrate`
- [ ] 迁移成功，无错误
- [ ] 已收集静态文件：`docker compose exec backend python manage.py collectstatic --noinput`
- [ ] 已创建超级用户：`docker compose exec backend python manage.py createsuperuser`

### 6. 验证部署
- [ ] 前端可访问：`curl http://localhost` 返回200
- [ ] 后端API可访问：`curl http://localhost:8000/api/users/users/me/` 返回401（正常，需要登录）
- [ ] Django Admin可访问：`curl http://localhost:8000/admin` 返回200
- [ ] 所有容器健康状态正常：`docker compose ps`
- [ ] 日志无严重错误：`docker compose logs --tail=50`

## 部署后配置

### 安全配置
- [ ] 已修改所有默认密码
- [ ] 已配置HTTPS（生产环境必须）
- [ ] 已限制数据库和Redis端口（仅内网访问）
- [ ] 已配置防火墙规则
- [ ] 已设置定期备份任务

### 性能优化
- [ ] 已使用生产环境配置：`docker-compose.prod.yml`
- [ ] 已配置资源限制（如需要）
- [ ] 已优化Gunicorn workers数量
- [ ] 已配置日志轮转

### 监控和维护
- [ ] 已设置服务监控（可选）
- [ ] 已配置日志收集（可选）
- [ ] 已设置定期备份任务
- [ ] 已记录部署信息（IP、端口、密码等）

## 故障排查检查

### 如果服务无法启动
- [ ] 检查Docker服务状态：`systemctl status docker`
- [ ] 检查容器状态：`docker compose ps -a`
- [ ] 查看错误日志：`docker compose logs`
- [ ] 检查端口占用：`netstat -tlnp | grep -E '80|8000|3306|6379'`
- [ ] 检查磁盘空间：`df -h`
- [ ] 检查内存使用：`free -h`

### 如果数据库连接失败
- [ ] 检查数据库容器状态：`docker compose ps db`
- [ ] 查看数据库日志：`docker compose logs db`
- [ ] 检查环境变量：`docker compose exec backend env | grep DB_`
- [ ] 测试数据库连接：`docker compose exec backend python manage.py dbshell`

### 如果前端无法访问
- [ ] 检查前端容器状态：`docker compose ps frontend`
- [ ] 查看前端日志：`docker compose logs frontend`
- [ ] 检查Nginx配置：`docker compose exec frontend cat /etc/nginx/conf.d/default.conf`
- [ ] 测试后端API：`curl http://localhost:8000/api/users/users/me/`

### 如果Celery任务不执行
- [ ] 检查Celery容器状态：`docker compose ps celery`
- [ ] 查看Celery日志：`docker compose logs celery`
- [ ] 检查Redis连接：`docker compose exec redis redis-cli ping`
- [ ] 重启Celery：`docker compose restart celery`

## 常用命令参考

```bash
# 查看服务状态
docker compose ps

# 查看日志
docker compose logs -f [service_name]

# 重启服务
docker compose restart [service_name]

# 停止服务
docker compose down

# 进入容器
docker compose exec backend bash

# 执行数据库迁移
docker compose exec backend python manage.py migrate

# 创建超级用户
docker compose exec backend python manage.py createsuperuser

# 查看资源使用
docker stats

# 备份数据库
docker compose exec db mysqldump -u root -p contract_review > backup.sql
```

## 部署完成确认

- [ ] 所有服务正常运行
- [ ] 前端可以正常访问
- [ ] 后端API可以正常访问
- [ ] 可以正常登录系统
- [ ] 可以创建审核任务
- [ ] AI审核功能正常
- [ ] 文件上传功能正常
- [ ] 数据库备份已配置

## 部署信息记录

请记录以下信息以便后续维护：

- **服务器IP**: ________________
- **部署目录**: ________________
- **前端访问地址**: ________________
- **后端API地址**: ________________
- **数据库密码**: ________________（已安全保存）
- **Django SECRET_KEY**: ________________（已安全保存）
- **超级用户账号**: ________________
- **部署日期**: ________________
- **部署人员**: ________________

---

**注意**: 部署完成后，请妥善保管密码和密钥信息，建议使用密码管理器保存。

