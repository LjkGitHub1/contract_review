# 服务器快速部署命令

## 一键部署（推荐）

```bash
# 上传项目到服务器后，执行：
sudo bash 服务器部署一键脚本.sh
```

## 手动部署步骤

### 1. 安装Docker（如果未安装）

**Ubuntu/Debian:**
```bash
sudo apt-get update
sudo apt-get install -y ca-certificates curl gnupg lsb-release
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
sudo systemctl start docker
sudo systemctl enable docker
```

**CentOS/RHEL:**
```bash
sudo yum install -y yum-utils
sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
sudo yum install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
sudo systemctl start docker
sudo systemctl enable docker
```

### 2. 上传项目到服务器

```bash
# 方式1: 使用Git
cd /opt
sudo git clone <your-repo-url> contract_review
cd contract_review

# 方式2: 使用SCP（在本地执行）
scp -r /path/to/AI合同 root@your-server-ip:/opt/contract_review
```

### 3. 配置环境变量

```bash
cd /opt/contract_review
cp .env.example .env
nano .env  # 或 vim .env
```

**必须修改的配置：**
```env
DEBUG=False
SECRET_KEY=<生成强密钥>
DB_PASSWORD=<强密码>
DB_ROOT_PASSWORD=<强密码>
CORS_ALLOWED_ORIGINS=https://yourdomain.com
```

**生成SECRET_KEY:**
```bash
python3 -c 'from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())'
```

### 4. 配置防火墙

```bash
# Ubuntu/Debian
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable

# CentOS/RHEL
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=443/tcp
sudo firewall-cmd --reload
```

### 5. 构建和启动

```bash
# 构建镜像
sudo docker compose build

# 启动服务（生产环境）
sudo docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d

# 或使用默认配置
sudo docker compose up -d
```

### 6. 初始化数据库

```bash
# 等待数据库启动
sleep 30

# 执行迁移
sudo docker compose exec backend python manage.py migrate

# 收集静态文件
sudo docker compose exec backend python manage.py collectstatic --noinput

# 创建超级用户
sudo docker compose exec backend python manage.py createsuperuser
```

### 7. 验证部署

```bash
# 查看服务状态
sudo docker compose ps

# 测试前端
curl http://localhost

# 测试后端
curl http://localhost:8000/api/users/users/me/

# 查看日志
sudo docker compose logs --tail=50
```

## 常用管理命令

### 服务管理

```bash
# 启动服务
sudo docker compose up -d

# 停止服务
sudo docker compose down

# 重启服务
sudo docker compose restart

# 重启特定服务
sudo docker compose restart backend

# 查看服务状态
sudo docker compose ps

# 查看日志
sudo docker compose logs -f
sudo docker compose logs -f backend
```

### 数据库操作

```bash
# 执行迁移
sudo docker compose exec backend python manage.py migrate

# 创建超级用户
sudo docker compose exec backend python manage.py createsuperuser

# 进入Django shell
sudo docker compose exec backend python manage.py shell

# 进入MySQL
sudo docker compose exec db mysql -u root -p
```

### 备份和恢复

```bash
# 备份数据库
sudo docker compose exec db mysqldump -u root -p contract_review > backup_$(date +%Y%m%d_%H%M%S).sql

# 恢复数据库
sudo docker compose exec -T db mysql -u root -p contract_review < backup.sql
```

### 更新部署

```bash
# 1. 备份数据库
sudo docker compose exec db mysqldump -u root -p contract_review > backup_before_update_$(date +%Y%m%d_%H%M%S).sql

# 2. 拉取最新代码
sudo git pull
# 或重新上传文件

# 3. 重新构建
sudo docker compose build

# 4. 重启服务
sudo docker compose down
sudo docker compose up -d

# 5. 执行迁移
sudo docker compose exec backend python manage.py migrate

# 6. 收集静态文件
sudo docker compose exec backend python manage.py collectstatic --noinput
```

## 故障排查命令

```bash
# 查看所有服务日志
sudo docker compose logs

# 查看特定服务日志
sudo docker compose logs backend
sudo docker compose logs celery

# 检查容器状态
sudo docker compose ps -a

# 检查资源使用
sudo docker stats

# 检查端口占用
sudo netstat -tlnp | grep -E '80|8000|3306|6379'

# 检查磁盘空间
df -h

# 检查内存
free -h

# 进入容器调试
sudo docker compose exec backend bash
sudo docker compose exec db bash
```

## 生产环境优化

```bash
# 使用生产环境配置
sudo docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d

# 设置定时备份（编辑crontab）
crontab -e
# 添加: 0 2 * * * cd /opt/contract_review && docker compose exec -T db mysqldump -u root -p<password> contract_review > /opt/backups/daily_backup_$(date +\%Y\%m\%d).sql

# 设置服务自动重启检查（可选）
crontab -e
# 添加: */5 * * * * cd /opt/contract_review && docker compose ps | grep -q "Up" || docker compose up -d
```

## 快速参考

| 操作 | 命令 |
|------|------|
| 启动服务 | `sudo docker compose up -d` |
| 停止服务 | `sudo docker compose down` |
| 查看状态 | `sudo docker compose ps` |
| 查看日志 | `sudo docker compose logs -f` |
| 重启服务 | `sudo docker compose restart` |
| 进入容器 | `sudo docker compose exec backend bash` |
| 执行迁移 | `sudo docker compose exec backend python manage.py migrate` |
| 创建用户 | `sudo docker compose exec backend python manage.py createsuperuser` |
| 备份数据库 | `sudo docker compose exec db mysqldump -u root -p contract_review > backup.sql` |

