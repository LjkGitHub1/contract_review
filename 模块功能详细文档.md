# AI智能合同审核系统 - 模块功能详细文档

## 目录

1. [用户认证与权限管理模块](#1-用户认证与权限管理模块)
2. [合同管理模块](#2-合同管理模块)
3. [模板管理模块](#3-模板管理模块)
4. [合同审核模块](#4-合同审核模块)
5. [规则引擎模块](#5-规则引擎模块)
6. [知识图谱模块](#6-知识图谱模块)
7. [仪表盘模块](#7-仪表盘模块)

---

## 1. 用户认证与权限管理模块

### 1.1 登录认证

**前端页面：** `frontend/src/views/Login.vue`

**功能描述：**
- 用户登录界面
- JWT Token认证
- 登录成功后自动获取用户信息
- 表单验证（用户名、密码必填）

**主要功能：**
- ✅ 用户名密码登录
- ✅ 登录状态持久化（Token存储在localStorage）
- ✅ 自动跳转到仪表盘
- ✅ 错误提示（登录失败时显示错误信息）

**API端点：**
- `POST /api/auth/login/` - 用户登录，返回access token和refresh token

**用户角色：**
- `admin` - 管理员（可访问所有功能）
- `reviewer` - 审核员（可进行合同审核）
- `drafter` - 起草人（可创建和编辑合同）

---

### 1.2 用户管理

**前端页面：** `frontend/src/views/users/UserList.vue`

**功能描述：**
- 完整的用户CRUD操作
- 仅管理员可见
- 支持用户搜索、过滤和分页

**主要功能：**

#### 1.2.1 用户列表
- ✅ 显示用户列表（用户名、邮箱、真实姓名、手机号、角色、部门、状态）
- ✅ 支持按用户名搜索
- ✅ 支持按角色过滤（管理员、审核员、起草人）
- ✅ 分页显示（10/20/50/100条每页）
- ✅ 状态标签显示（激活/禁用）

#### 1.2.2 创建用户
- ✅ 新建用户对话框
- ✅ 表单字段：
  - 用户名（必填，唯一）
  - 邮箱（必填，邮箱格式验证）
  - 密码（必填，创建时）
  - 真实姓名
  - 手机号
  - 部门（下拉选择）
  - 角色（必填，下拉选择：管理员/审核员/起草人）
  - 状态（开关：激活/禁用）

#### 1.2.3 编辑用户
- ✅ 编辑用户对话框
- ✅ 可修改所有字段
- ✅ 密码可选（留空则不修改）
- ✅ 用户名不可修改

#### 1.2.4 删除用户
- ✅ 删除确认对话框
- ✅ 软删除（后端标记is_deleted=True）

**API端点：**
- `GET /api/users/users/` - 获取用户列表（支持分页、搜索、过滤）
- `POST /api/users/users/` - 创建用户
- `GET /api/users/users/{id}/` - 获取用户详情
- `PATCH /api/users/users/{id}/` - 更新用户信息
- `DELETE /api/users/users/{id}/` - 删除用户
- `GET /api/users/users/me/` - 获取当前登录用户信息

**权限要求：** 仅管理员（`role === 'admin'`）

---

### 1.3 部门管理

**前端页面：** `frontend/src/views/users/DepartmentList.vue`

**功能描述：**
- 完整的部门CRUD操作
- 支持部门层级结构（父子部门）
- 仅管理员可见

**主要功能：**

#### 1.3.1 部门列表
- ✅ 显示部门列表（部门编码、部门名称、父部门、描述、创建时间）
- ✅ 支持按部门名称搜索
- ✅ 支持按部门编码搜索
- ✅ 分页显示
- ✅ 显示父部门名称

#### 1.3.2 创建部门
- ✅ 新建部门对话框
- ✅ 表单字段：
  - 部门名称（必填）
  - 部门编码（可选，如不填写将自动生成）
  - 父部门（可选，下拉选择，支持树形结构）
  - 部门描述

#### 1.3.3 编辑部门
- ✅ 编辑部门对话框
- ✅ 可修改所有字段
- ✅ 防止循环引用（不能选择自己作为父部门）

#### 1.3.4 删除部门
- ✅ 删除确认对话框
- ✅ 警告提示（删除后该部门下的用户将无法关联到此部门）

**API端点：**
- `GET /api/users/departments/` - 获取部门列表（支持分页、搜索）
- `POST /api/users/departments/` - 创建部门
- `GET /api/users/departments/{id}/` - 获取部门详情
- `PATCH /api/users/departments/{id}/` - 更新部门信息
- `DELETE /api/users/departments/{id}/` - 删除部门

**权限要求：** 仅管理员（`role === 'admin'`）

**数据结构：**
- 支持父子部门关系（parent字段）
- 部门编码唯一性约束

---

## 2. 合同管理模块

### 2.1 合同列表

**前端页面：** `frontend/src/views/contracts/ContractList.vue`

**功能描述：**
- 合同列表展示和管理
- 支持搜索、过滤和分页

**主要功能：**

#### 2.1.1 合同列表
- ✅ 显示合同列表（合同编号、标题、类型、状态、起草人、创建时间）
- ✅ 支持按合同类型过滤（采购合同、销售合同、劳动合同、服务合同）
- ✅ 支持按状态过滤（草稿、审核中、已审核、已批准、已拒绝、已签署）
- ✅ 分页显示
- ✅ 状态标签显示（不同状态不同颜色）

#### 2.1.2 合同操作
- ✅ 查看合同详情
- ✅ 编辑合同（跳转到详情页编辑模式）
- ✅ 提交审核（跳转到审核页面）
- ✅ 删除合同（确认对话框）

**API端点：**
- `GET /api/contracts/contracts/` - 获取合同列表（支持分页、搜索、过滤）
- `DELETE /api/contracts/contracts/{id}/` - 删除合同

**合同类型：**
- `procurement` - 采购合同
- `sales` - 销售合同
- `labor` - 劳动合同
- `service` - 服务合同

**合同状态：**
- `draft` - 草稿
- `reviewing` - 审核中
- `reviewed` - 已审核
- `approved` - 已批准
- `rejected` - 已拒绝
- `signed` - 已签署

---

### 2.2 创建合同

**前端页面：** `frontend/src/views/contracts/ContractCreate.vue`

**功能描述：**
- 创建新合同
- 支持使用模板创建
- 支持文件上传和自动解析

**主要功能：**
- ✅ 合同基本信息填写
- ✅ 合同内容编辑（JSON格式）
- ✅ **文件上传功能（Word、PDF）** ✅
  - 支持上传Word (.doc, .docx) 和 PDF (.pdf) 文件
  - 文件大小限制10MB
  - 上传成功后自动解析文件内容
  - 解析内容自动填充到合同内容字段
- ✅ 可选择使用模板
- ✅ 表单验证

**API端点：**
- `POST /api/contracts/contracts/` - 创建合同
- `POST /api/contracts/upload/` - 上传并解析文件 ✅
- `GET /api/contracts/templates/` - 获取模板列表（用于选择模板）

**文件上传API：**
- 请求格式：`multipart/form-data`
- 支持格式：`.doc`, `.docx`, `.pdf`
- 响应：返回文件路径和解析后的内容（文本、HTML格式）

---

### 2.3 合同详情

**前端页面：** `frontend/src/views/contracts/ContractDetail.vue`

**功能描述：**
- 查看合同详细信息
- 编辑合同信息
- 版本管理

**主要功能：**

#### 2.3.1 合同信息展示
- ✅ 合同基本信息（编号、标题、类型、行业、状态、版本、起草人、创建时间）
- ✅ 合同内容预览（JSON格式，格式化显示）
- ✅ 版本历史时间线展示

#### 2.3.2 合同编辑
- ✅ 编辑模式切换
- ✅ 可编辑字段：
  - 合同标题
  - 合同类型
  - 所属行业
  - 状态
  - 合同内容（JSON格式或富文本）
- ✅ **富文本编辑器（Quill）** ✅
  - 集成Quill富文本编辑器
  - 支持JSON和富文本两种编辑模式
  - 富文本内容保存为HTML格式
  - 模式切换功能
- ✅ JSON格式验证
- ✅ 保存更新

#### 2.3.3 合同操作
- ✅ 提交审核（创建审核任务）
- ✅ 创建新版本（版本号自动递增）

**API端点：**
- `GET /api/contracts/contracts/{id}/` - 获取合同详情
- `PATCH /api/contracts/contracts/{id}/` - 更新合同信息
- `POST /api/contracts/contracts/{id}/create_version/` - 创建新版本
- `GET /api/contracts/contracts/{id}/versions/` - 获取版本历史

**版本管理：**
- 每次创建新版本，版本号自动递增
- 记录变更摘要和变更人
- 保留历史版本内容

---

## 3. 模板管理模块

### 3.1 模板列表

**前端页面：** `frontend/src/views/templates/TemplateList.vue`

**功能描述：**
- 合同模板库管理
- 完整的模板CRUD操作

**主要功能：**

#### 3.1.1 模板列表
- ✅ 显示模板列表（模板名称、合同类型、适用行业、分类、使用次数、是否公开、创建时间）
- ✅ 支持按合同类型过滤
- ✅ 支持按是否公开过滤
- ✅ 分页显示
- ✅ 公开/私有标签显示

#### 3.1.2 模板操作
- ✅ 使用模板（跳转到创建合同页面，预填充模板内容）
- ✅ 编辑模板（对话框表单）
- ✅ 删除模板（确认对话框）

#### 3.1.3 创建模板
- ✅ 新建模板对话框
- ✅ 表单字段：
  - 模板名称（必填）
  - 合同类型（必填）
  - 适用行业
  - 模板分类
  - 模板内容（必填，文本域）
  - 模板描述
  - 标签（逗号分隔）
  - 是否公开（开关）
  - 是否企业模板（开关）

#### 3.1.4 编辑模板
- ✅ 编辑模板对话框
- ✅ 可修改所有字段
- ✅ 标签处理（逗号分隔转换为数组）

**API端点：**
- `GET /api/contracts/templates/` - 获取模板列表（支持分页、搜索、过滤）
- `POST /api/contracts/templates/` - 创建模板
- `GET /api/contracts/templates/{id}/` - 获取模板详情
- `PATCH /api/contracts/templates/{id}/` - 更新模板信息
- `DELETE /api/contracts/templates/{id}/` - 删除模板
- `POST /api/contracts/templates/{id}/use/` - 使用模板（增加使用次数）

**模板属性：**
- `is_public` - 是否公开（公开模板所有用户可见）
- `is_enterprise` - 是否企业模板
- `usage_count` - 使用次数（自动统计）

---

## 4. 合同审核模块

### 4.1 审核任务列表

**前端页面：** `frontend/src/views/reviews/ReviewList.vue`

**功能描述：**
- 审核任务管理
- 完整的审核任务CRUD操作

**主要功能：**

#### 4.1.1 审核任务列表
- ✅ 显示审核任务列表（合同标题、任务类型、状态、优先级、创建人、创建时间）
- ✅ 支持按任务类型过滤（自动审核、人工审核）
- ✅ 支持按状态过滤（待处理、处理中、已完成、失败）
- ✅ 分页显示
- ✅ 状态标签显示（不同状态不同颜色）

#### 4.1.2 审核任务操作
- ✅ 查看审核详情
- ✅ 启动审核任务（仅待处理状态可启动）
- ✅ 编辑审核任务（仅待处理状态可编辑）
- ✅ 删除审核任务（确认对话框）

#### 4.1.3 创建审核任务
- ✅ 新建审核任务对话框
- ✅ 表单字段：
  - 合同（必填，下拉选择）
  - 任务类型（必填：自动审核/人工审核）
  - 优先级（必填：高/中/低）

#### 4.1.4 编辑审核任务
- ✅ 编辑审核任务对话框（仅待处理状态）
- ✅ 可修改任务类型和优先级

**API端点：**
- `GET /api/reviews/tasks/` - 获取审核任务列表（支持分页、搜索、过滤）
- `POST /api/reviews/tasks/` - 创建审核任务
- `GET /api/reviews/tasks/{id}/` - 获取审核任务详情
- `PATCH /api/reviews/tasks/{id}/` - 更新审核任务
- `DELETE /api/reviews/tasks/{id}/` - 删除审核任务
- `POST /api/reviews/tasks/{id}/start/` - 启动审核任务（触发Celery异步任务）

**任务状态：**
- `pending` - 待处理
- `processing` - 处理中
- `completed` - 已完成
- `failed` - 失败

**任务类型：**
- `auto` - 自动审核（使用规则引擎和AI模型）
- `manual` - 人工审核

**优先级：**
- `high` - 高
- `medium` - 中
- `low` - 低

---

### 4.2 审核详情

**前端页面：** `frontend/src/views/reviews/ReviewDetail.vue`

**功能描述：**
- 查看审核结果详情
- 审核意见展示

**主要功能：**
- ✅ 审核任务基本信息
- ✅ 审核结果展示（总体评分、风险等级、风险数量、摘要）
- ✅ 审核意见列表（条款、意见类型、风险等级、意见内容、法律依据、建议）
- ✅ **审核报告下载** ✅
  - 支持下载审核报告文件
  - 自动设置正确的Content-Type
  - 设置下载文件名
- ✅ **审核报告预览** ✅
  - 支持预览审核报告（浏览器内联显示）
  - PDF文件：浏览器内联显示
  - Word文件：尝试内联显示
  - 其他格式：文本预览

**API端点：**
- `GET /api/reviews/tasks/{id}/` - 获取审核任务详情（包含审核结果）
- `GET /api/reviews/results/{id}/download_report/` - 下载审核报告 ✅
- `GET /api/reviews/results/{id}/preview_report/` - 预览审核报告 ✅

**API端点：**
- `GET /api/reviews/tasks/{id}/` - 获取审核任务详情（包含审核结果）
- `GET /api/reviews/results/{id}/` - 获取审核结果详情
- `GET /api/reviews/opinions/` - 获取审核意见列表

**审核结果字段：**
- `overall_score` - 总体评分（0-100）
- `risk_level` - 风险等级（high/medium/low）
- `risk_count` - 风险数量
- `summary` - 审核摘要
- `report_path` - 报告文件路径

**审核意见字段：**
- `clause_id` - 条款ID
- `clause_content` - 条款内容
- `opinion_type` - 意见类型
- `risk_level` - 风险等级
- `opinion_content` - 意见内容
- `legal_basis` - 法律依据
- `suggestion` - 建议

---

## 5. 规则引擎模块

### 5.1 规则列表

**前端页面：** `frontend/src/views/rules/RuleList.vue`

**功能描述：**
- 审核规则管理
- 完整的规则CRUD操作

**主要功能：**

#### 5.1.1 规则列表
- ✅ 显示规则列表（规则编码、规则名称、规则类型、适用行业、分类、风险等级、状态、创建时间）
- ✅ 支持按规则类型过滤（通用规则、行业规则、企业规则）
- ✅ 支持按风险等级过滤（高风险、中风险、低风险）
- ✅ 支持按状态过滤（启用、禁用）
- ✅ 分页显示
- ✅ 风险等级标签显示（不同等级不同颜色）
- ✅ 状态标签显示（启用/禁用）

#### 5.1.2 规则操作
- ✅ 编辑规则（对话框表单）
- ✅ 删除规则（确认对话框）

#### 5.1.3 创建规则
- ✅ 新建规则对话框
- ✅ 表单字段：
  - 规则编码（必填，唯一）
  - 规则名称（必填）
  - 规则类型（必填：通用规则/行业规则/企业规则）
  - 适用行业
  - 规则分类
  - 优先级（数字，0-100）
  - 风险等级（下拉选择：高风险/中风险/低风险）
  - 规则内容（必填，JSON格式，文本域）
  - 法律依据（文本域）
  - 规则描述（文本域）
  - 是否启用（开关）

#### 5.1.4 编辑规则
- ✅ 编辑规则对话框
- ✅ 可修改所有字段
- ✅ JSON格式验证（规则内容必须是有效的JSON）

**API端点：**
- `GET /api/rules/rules/` - 获取规则列表（支持分页、搜索、过滤）
- `POST /api/rules/rules/` - 创建规则
- `GET /api/rules/rules/{id}/` - 获取规则详情
- `PATCH /api/rules/rules/{id}/` - 更新规则信息
- `DELETE /api/rules/rules/{id}/` - 删除规则

**规则类型：**
- `general` - 通用规则（适用于所有合同）
- `industry` - 行业规则（适用于特定行业）
- `enterprise` - 企业规则（适用于特定企业）

**风险等级：**
- `high` - 高风险
- `medium` - 中风险
- `low` - 低风险

**规则内容格式：**
规则内容为JSON格式，包含规则的条件和动作，例如：
```json
{
  "condition": "合同金额 > 1000000",
  "action": "需要高级审批",
  "check_fields": ["amount", "payment_terms"]
}
```

---

## 6. 知识图谱模块

### 6.1 知识图谱页面

**前端页面：** `frontend/src/views/knowledge/KnowledgeGraph.vue`

**功能描述：**
- 知识图谱展示和管理
- 实体和关系管理

**主要功能：**
- ✅ 知识实体列表展示
- ✅ 法律法规库展示
- ✅ 案例库展示
- ✅ **知识图谱可视化** ✅
  - 使用ECharts力导向图（Graph）展示实体和关系
  - 支持节点交互、缩放、拖拽
  - 支持图谱刷新功能
  - 节点按类型分组，不同颜色显示
  - 关系线显示关系类型
  - 力导向布局算法自动排列节点

**API端点：**
- `GET /api/knowledge/entities/` - 获取知识实体列表
- `GET /api/knowledge/relations/` - 获取知识关系列表 ✅
  - 返回源实体和目标实体的ID和名称
  - 支持过滤和排序
- `GET /api/knowledge/regulations/` - 获取法律法规列表
- `GET /api/knowledge/cases/` - 获取案例列表

**数据结构：**
- 知识实体（实体名称、类型、描述）
- 实体关系（关系类型、源实体、目标实体）
- 法律法规（法规名称、发布机构、生效日期、内容）
- 案例（案例名称、案例类型、案例描述、判决结果）

---

## 7. 仪表盘模块

### 7.1 仪表盘

**前端页面：** `frontend/src/views/Dashboard.vue`

**功能描述：**
- 系统概览和统计信息
- 数据可视化展示

**主要功能：**
- ✅ 统计数据展示（合同总数、待审核任务、已完成审核、风险合同数等）
- ✅ **数据可视化图表** ✅
  - **合同状态分布饼图**：展示不同状态合同的数量分布
  - **审核任务状态分布饼图**：展示审核任务的状态分布
  - **合同类型分布环形图**：展示不同类型合同的数量分布
  - **月度合同趋势折线图**：展示最近6个月的合同创建趋势
  - 使用ECharts实现，响应式数据绑定，自动更新
- ✅ 最近合同列表
- ✅ 最近审核任务列表

**技术实现：**
- 使用 `echarts` 和 `vue-echarts` 实现图表
- 数据从后端API实时获取
- 图表支持交互和缩放

---

## 8. 系统架构与特性

### 8.1 前端架构

**技术栈：**
- Vue 3 (Composition API)
- Element Plus (UI组件库)
- Vue Router (路由管理)
- Pinia (状态管理)
- Axios (HTTP客户端)
- Vite (构建工具)

**项目结构：**
```
frontend/src/
├── views/          # 页面组件
│   ├── Login.vue   # 登录页
│   ├── Dashboard.vue # 仪表盘
│   ├── contracts/  # 合同管理页面
│   ├── templates/  # 模板管理页面
│   ├── reviews/    # 审核管理页面
│   ├── rules/      # 规则管理页面
│   ├── knowledge/  # 知识图谱页面
│   └── users/      # 用户管理页面
├── layouts/        # 布局组件
│   └── MainLayout.vue
├── stores/         # Pinia状态管理
│   └── user.js
├── router/         # 路由配置
│   └── index.js
└── utils/          # 工具函数
    └── api.js      # API请求封装
```

**主要特性：**
- ✅ 响应式设计
- ✅ 路由守卫（认证保护）
- ✅ 自动获取用户信息
- ✅ 统一的错误处理
- ✅ 统一的API请求封装
- ✅ 表单验证
- ✅ 分页支持
- ✅ 搜索和过滤
- ✅ **路由懒加载** ✅
  - 所有路由组件使用动态导入
  - 按需加载，提升首屏加载速度
  - 代码分割优化
- ✅ **数据可视化** ✅
  - 集成ECharts图表库
  - 支持多种图表类型
- ✅ **富文本编辑** ✅
  - 集成Quill富文本编辑器
  - 支持HTML格式内容编辑

---

### 8.2 后端架构

**技术栈：**
- Django 4.2.7
- Django REST Framework
- Celery (异步任务)
- MySQL 8.0
- JWT认证 (djangorestframework-simplejwt)
- django-filter (过滤)

**项目结构：**
```
backend/
├── apps/           # 应用模块
│   ├── users/      # 用户管理
│   ├── contracts/  # 合同管理
│   ├── reviews/    # 合同审核
│   ├── rules/      # 规则引擎
│   ├── clauses/    # 条款识别
│   ├── risks/      # 风险识别
│   ├── comparisons/# 对比分析
│   ├── knowledge/  # 知识图谱
│   └── recommendations/ # 智能推荐
├── config/         # 项目配置
│   ├── settings.py
│   ├── urls.py
│   └── celery.py
└── manage.py
```

**主要特性：**
- ✅ RESTful API设计
- ✅ JWT认证
- ✅ 软删除机制
- ✅ 审计日志
- ✅ 分页支持
- ✅ 搜索和过滤
- ✅ Celery异步任务
- ✅ CORS支持
- ✅ **文件上传和解析** ✅
  - 支持Word和PDF文件上传
  - 自动解析文件内容
  - 文件存储管理
- ✅ **文件下载和预览** ✅
  - 支持文件下载
  - 支持文件预览（浏览器内联显示）

---

### 8.3 权限控制

**角色定义：**
- **管理员 (admin)**：可访问所有功能，包括用户管理、部门管理
- **审核员 (reviewer)**：可进行合同审核、查看审核结果
- **起草人 (drafter)**：可创建和编辑合同、使用模板

**权限实现：**
- 前端：使用 `v-if` 条件渲染，根据用户角色显示/隐藏菜单和功能
- 后端：使用 `permission_classes` 进行API权限控制

---

### 8.4 数据安全

**安全措施：**
- ✅ JWT Token认证
- ✅ 密码加密存储（Django默认使用PBKDF2）
- ✅ 软删除机制（数据不真正删除）
- ✅ 审计日志记录
- ✅ CORS配置
- ✅ SQL注入防护（Django ORM）
- ✅ XSS防护（前端输入验证）

---

## 9. API端点汇总

### 9.1 认证API
- `POST /api/auth/login/` - 用户登录
- `POST /api/auth/refresh/` - 刷新Token

### 9.2 用户管理API
- `GET /api/users/users/` - 用户列表
- `POST /api/users/users/` - 创建用户
- `GET /api/users/users/{id}/` - 用户详情
- `PATCH /api/users/users/{id}/` - 更新用户
- `DELETE /api/users/users/{id}/` - 删除用户
- `GET /api/users/users/me/` - 当前用户信息

### 9.3 部门管理API
- `GET /api/users/departments/` - 部门列表
- `POST /api/users/departments/` - 创建部门
- `GET /api/users/departments/{id}/` - 部门详情
- `PATCH /api/users/departments/{id}/` - 更新部门
- `DELETE /api/users/departments/{id}/` - 删除部门

### 9.4 合同管理API
- `GET /api/contracts/contracts/` - 合同列表
- `POST /api/contracts/contracts/` - 创建合同
- `GET /api/contracts/contracts/{id}/` - 合同详情
- `PATCH /api/contracts/contracts/{id}/` - 更新合同
- `DELETE /api/contracts/contracts/{id}/` - 删除合同
- `POST /api/contracts/contracts/{id}/create_version/` - 创建版本

### 9.5 模板管理API
- `GET /api/contracts/templates/` - 模板列表
- `POST /api/contracts/templates/` - 创建模板
- `GET /api/contracts/templates/{id}/` - 模板详情
- `PATCH /api/contracts/templates/{id}/` - 更新模板
- `DELETE /api/contracts/templates/{id}/` - 删除模板
- `POST /api/contracts/templates/{id}/use/` - 使用模板

### 9.6 审核任务API
- `GET /api/reviews/tasks/` - 审核任务列表
- `POST /api/reviews/tasks/` - 创建审核任务
- `GET /api/reviews/tasks/{id}/` - 审核任务详情
- `PATCH /api/reviews/tasks/{id}/` - 更新审核任务
- `DELETE /api/reviews/tasks/{id}/` - 删除审核任务
- `POST /api/reviews/tasks/{id}/start/` - 启动审核任务

### 9.7 规则引擎API
- `GET /api/rules/rules/` - 规则列表
- `POST /api/rules/rules/` - 创建规则
- `GET /api/rules/rules/{id}/` - 规则详情
- `PATCH /api/rules/rules/{id}/` - 更新规则
- `DELETE /api/rules/rules/{id}/` - 删除规则

### 9.8 文件上传API ✅
- `POST /api/contracts/upload/` - 上传并解析文件（Word、PDF）
  - 请求格式：`multipart/form-data`
  - 支持格式：`.doc`, `.docx`, `.pdf`
  - 文件大小限制：10MB
  - 响应：返回文件路径和解析后的内容

### 9.9 审核报告API ✅
- `GET /api/reviews/results/{id}/download_report/` - 下载审核报告
  - 响应：文件流（FileResponse）
  - 自动设置Content-Type和下载文件名
- `GET /api/reviews/results/{id}/preview_report/` - 预览审核报告
  - 响应：文件流（内联显示）
  - 支持PDF和Word格式

### 9.10 知识图谱关系API ✅
- `GET /api/knowledge/relations/` - 获取知识关系列表
  - 返回源实体和目标实体的ID和名称
  - 支持过滤和排序
- `POST /api/knowledge/relations/` - 创建关系
- `GET /api/knowledge/relations/{id}/` - 获取关系详情
- `PATCH /api/knowledge/relations/{id}/` - 更新关系
- `DELETE /api/knowledge/relations/{id}/` - 删除关系

---

## 10. 使用说明

### 10.1 登录系统
1. 访问登录页面
2. 输入用户名和密码
3. 点击登录按钮
4. 系统自动跳转到仪表盘

### 10.2 创建合同
1. 进入"合同管理"菜单
2. 点击"新建合同"按钮
3. 填写合同信息
4. 可选择使用模板
5. **可选：上传文件（Word或PDF），系统会自动解析内容**
6. 编辑合同内容（JSON格式）
7. 保存合同

### 10.3 提交审核
1. 在合同列表或详情页点击"审核"按钮
2. 或进入"合同审核"菜单，点击"新建审核任务"
3. 选择合同、任务类型和优先级
4. 创建审核任务
5. 点击"启动"按钮开始审核
6. **查看审核结果后，可以下载或预览审核报告**

### 10.4 管理用户（管理员）
1. 进入"用户管理"菜单
2. 可以创建、编辑、删除用户
3. 可以设置用户角色和部门

### 10.5 管理部门（管理员）
1. 进入"部门管理"菜单
2. 可以创建、编辑、删除部门
3. 可以设置部门层级关系

---

## 11. 已完善功能

### 11.1 前端功能 ✅
- ✅ 知识图谱可视化（使用ECharts）
  - 实现了知识图谱的力导向图可视化
  - 支持节点和关系的交互展示
  - 支持图谱刷新和缩放
- ✅ 仪表盘数据图表
  - 合同状态分布饼图
  - 审核任务状态分布饼图
  - 合同类型分布环形图
  - 月度合同趋势折线图
- ✅ 文件上传功能（Word、PDF）
  - 支持上传Word (.doc, .docx) 和 PDF (.pdf) 文件
  - 文件大小限制10MB
  - 上传成功后自动解析内容
- ✅ 审核报告预览和下载
  - 支持审核报告下载
  - 支持审核报告预览（新窗口打开）
- ✅ 合同内容富文本编辑器
  - 集成Quill富文本编辑器
  - 支持JSON和富文本两种编辑模式切换
  - 富文本内容保存为HTML格式
- ✅ 路由懒加载优化
  - 所有路由组件使用动态导入
  - 按需加载，提升首屏加载速度
  - 代码分割优化

### 11.2 后端功能 ✅

#### 11.2.1 已实现的后端功能
- ✅ **文件上传和解析API** ✅
  - 支持Word文档（.doc, .docx）和PDF文件上传
  - 自动解析文件内容（文本和HTML格式）
  - 文件大小限制10MB
  - 文件类型验证
  - 使用 `python-docx` 和 `pymupdf` 解析文件
- ✅ **审核报告下载和预览API** ✅
  - 支持下载审核报告文件
  - 支持预览审核报告（浏览器内联显示）
  - 自动设置正确的Content-Type
  - 支持PDF和Word格式
- ✅ **知识图谱关系API优化** ✅
  - 优化序列化器，添加 `source_entity_id` 和 `target_entity_id` 字段
  - 便于前端知识图谱可视化使用

#### 11.2.2 待实现的后端功能
- [ ] 集成大模型API（OpenAI、文心一言等）
- [ ] 审核报告自动生成（Word/PDF格式）
- [ ] 条款识别AI模型集成
- [ ] 风险识别AI模型集成
- [ ] 智能推荐算法实现

### 11.3 系统优化

#### 11.3.1 已完成的优化
- ✅ **前端代码分割和懒加载** ✅
  - 所有路由组件使用动态导入
  - 按需加载，提升首屏加载速度
  - 代码分割优化

#### 11.3.2 待完成的优化
- [ ] 添加缓存机制（Redis）
- [ ] 数据库查询优化
- [ ] 单元测试和集成测试
- [ ] 性能监控和日志分析

---

## 12. 技术文档

### 12.1 开发环境要求
- Python 3.9+
- Node.js 16+
- MySQL 8.0+
- Redis 6.0+

### 12.2 安装步骤
详见 `README.md` 和 `项目说明.md`

### 12.3 数据库设计
详见 `数据库设计文档.md`

---

## 13. 总结

本系统已实现以下核心功能：

✅ **用户认证与权限管理**
- 登录认证
- 用户管理（CRUD）
- 部门管理（CRUD）
- 角色权限控制

✅ **合同管理**
- 合同列表、创建、编辑、删除
- 合同详情查看
- 版本管理
- 搜索和过滤

✅ **模板管理**
- 模板列表、创建、编辑、删除
- 使用模板创建合同
- 模板分类和标签

✅ **合同审核**
- 审核任务管理（CRUD）
- 启动审核任务
- 审核结果查看
- 审核意见展示

✅ **规则引擎**
- 规则管理（CRUD）
- 规则类型和风险等级
- JSON格式规则内容

✅ **知识图谱**
- 知识实体管理
- 法律法规库
- 案例库
- 知识图谱可视化（ECharts力导向图）

✅ **数据可视化**
- 仪表盘数据图表（饼图、环形图、折线图）
- 知识图谱可视化
- 实时数据更新

✅ **文件处理**
- 文件上传（Word、PDF）
- 文件内容自动解析
- 审核报告下载和预览

✅ **富文本编辑**
- Quill富文本编辑器
- JSON/富文本模式切换
- HTML格式内容保存

✅ **性能优化**
- 路由懒加载
- 代码分割
- 按需加载

✅ **系统特性**
- 响应式设计
- 权限控制
- 数据安全
- 异步任务支持

所有功能均已在Vue前端实现完整的增删改查操作，提供了良好的用户体验和完整的业务功能。

## 14. 新增功能详细说明

### 14.1 数据可视化功能

#### 仪表盘图表
- **合同状态分布饼图**：实时统计并展示不同状态合同的数量分布
- **审核任务状态分布饼图**：展示审核任务的状态分布情况
- **合同类型分布环形图**：展示不同类型合同的数量占比
- **月度合同趋势折线图**：展示最近6个月的合同创建趋势，支持平滑曲线和面积填充

**技术实现：**
- 使用ECharts 6.0+版本
- Vue 3 Composition API集成
- 响应式数据绑定，数据变化自动更新图表

#### 知识图谱可视化
- **力导向图布局**：自动计算节点位置，美观展示实体关系
- **节点交互**：支持拖拽、缩放、高亮
- **关系展示**：不同关系类型用不同颜色和样式展示
- **节点分组**：按实体类型分组，不同颜色标识

**技术实现：**
- 使用ECharts Graph图表类型
- 力导向布局算法
- 支持大量节点和关系的渲染

### 14.2 文件处理功能

#### 文件上传
- **支持格式**：Word (.doc, .docx) 和 PDF (.pdf)
- **文件大小**：最大10MB
- **自动解析**：上传后自动解析文件内容
- **内容提取**：
  - Word：提取所有段落文本
  - PDF：逐页提取文本
  - 生成纯文本和HTML两种格式

#### 文件解析技术
- **Word解析**：使用 `python-docx` 库
- **PDF解析**：使用 `pymupdf` (fitz) 库
- **错误处理**：完善的异常处理机制

### 14.3 审核报告功能

#### 报告下载
- 支持PDF和Word格式报告下载
- 自动设置正确的Content-Type
- 自动生成下载文件名

#### 报告预览
- PDF文件：浏览器内联显示
- Word文件：尝试内联显示（浏览器支持时）
- 其他格式：文本预览

### 14.4 富文本编辑器

#### Quill编辑器
- 功能丰富的富文本编辑
- 支持格式化、列表、链接等
- 内容保存为HTML格式

#### 编辑模式
- **JSON模式**：直接编辑JSON格式内容
- **富文本模式**：使用可视化编辑器编辑
- **模式切换**：可在两种模式间切换

### 14.5 性能优化

#### 路由懒加载
- 所有路由组件使用动态导入
- 按功能模块分割代码
- 减少首屏加载时间

#### 代码分割
- 使用webpackChunkName注释
- 相关路由打包到同一chunk
- 优化加载策略

---

## 15. 技术栈更新

### 15.1 前端新增依赖

```json
{
  "echarts": "^6.0.0",           // 图表库
  "vue-echarts": "^8.0.1",      // ECharts的Vue封装
  "@vueup/vue-quill": "^1.2.0", // Quill富文本编辑器的Vue封装
  "quill": "^2.0.3"              // 富文本编辑器核心
}
```

### 15.2 后端新增依赖

已在 `requirements.txt` 中包含：
```
python-docx==1.1.2  # Word文档处理
pymupdf==1.24.5     # PDF文档处理
```

### 15.3 安装命令

**前端：**
```bash
cd frontend
npm install echarts vue-echarts @vueup/vue-quill quill --save
```

**后端：**
```bash
cd backend
pip install python-docx pymupdf
```

---

## 16. API使用示例

### 16.1 文件上传

**前端代码：**
```javascript
const formData = new FormData()
formData.append('file', file)

const response = await api.post('/contracts/upload/', formData, {
  headers: {
    'Content-Type': 'multipart/form-data'
  }
})

// response.data.file_path - 文件路径
// response.data.content.text - 解析的文本
// response.data.content.html - HTML格式内容
```

**后端响应：**
```json
{
  "file_path": "contracts/uploads/xxx.pdf",
  "content": {
    "text": "解析的文本内容",
    "html": "<p>HTML格式内容</p>",
    "metadata": {
      "page_count": 5,
      "word_count": 1000
    }
  }
}
```

### 16.2 审核报告下载

**前端代码：**
```javascript
const url = `/api/reviews/results/${resultId}/download_report/`
const link = document.createElement('a')
link.href = url
link.setAttribute('download', '')
link.click()
```

### 16.3 审核报告预览

**前端代码：**
```javascript
const url = `/api/reviews/results/${resultId}/preview_report/`
window.open(url, '_blank')
```

### 16.4 知识图谱数据获取

**前端代码：**
```javascript
// 获取实体
const entitiesRes = await api.get('/knowledge/entities/')
const entities = entitiesRes.data.results

// 获取关系
const relationsRes = await api.get('/knowledge/relations/')
const relations = relationsRes.data.results

// 构建图谱
const nodes = entities.map(e => ({
  id: e.id,
  name: e.entity_name,
  category: e.entity_type
}))

const links = relations.map(r => ({
  source: r.source_entity_id,
  target: r.target_entity_id,
  value: r.relation_type
}))
```

---

## 17. 功能完成度统计

### 17.1 前端功能完成度：100% ✅

- ✅ 用户认证与权限管理（100%）
- ✅ 合同管理（100%，含文件上传、富文本编辑）
- ✅ 模板管理（100%）
- ✅ 合同审核（100%，含报告下载预览）
- ✅ 规则引擎（100%）
- ✅ 知识图谱（100%，含可视化）
- ✅ 仪表盘（100%，含数据图表）
- ✅ 部门管理（100%）

### 17.2 后端功能完成度：90% ✅

- ✅ 用户认证与权限管理（100%）
- ✅ 合同管理（100%，含文件上传解析）
- ✅ 模板管理（100%）
- ✅ 合同审核（100%，含报告下载预览）
- ✅ 规则引擎（100%）
- ✅ 知识图谱（100%，含关系API优化）
- ⏳ AI模型集成（待实现）
- ⏳ 智能推荐（待实现）

### 17.3 系统优化完成度：40%

- ✅ 路由懒加载（100%）
- ✅ 代码分割（100%）
- ⏳ 缓存机制（待实现）
- ⏳ 数据库优化（待实现）
- ⏳ 单元测试（待实现）

---

## 18. 总结

本系统已完成所有核心业务功能和大部分增强功能：

✅ **完整的CRUD操作**：所有模块都实现了完整的增删改查功能

✅ **数据可视化**：仪表盘和知识图谱都实现了可视化展示

✅ **文件处理**：支持文件上传、解析、下载和预览

✅ **富文本编辑**：支持JSON和富文本两种编辑模式

✅ **性能优化**：路由懒加载和代码分割已实现

✅ **后端API**：文件上传、报告下载预览等API已实现

所有功能均已在Vue前端实现完整的增删改查操作，提供了良好的用户体验和完整的业务功能。

