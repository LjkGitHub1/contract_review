# AI模型配置500错误排查指南

## 错误现象

在访问AI模型配置页面时，出现500内部服务器错误：
- `GET /api/reviews/ai-model-configs/` 返回500错误
- 错误信息：`Request failed with status code 500`

## 可能原因

1. **数据库表未创建**：迁移文件未运行
2. **序列化器错误**：处理空值时的错误
3. **模型导入错误**：循环导入或其他导入问题

## 修复步骤

### 1. 检查数据库迁移

```bash
cd backend
python manage.py showmigrations reviews
```

如果看到 `[ ] 0005_aimodelconfig`，说明迁移未运行，需要执行：

```bash
python manage.py migrate reviews
```

### 2. 检查后端日志

查看后端服务的控制台输出，找到具体的错误信息。常见错误：

- `no such table: reviews_ai_model_config` - 数据库表不存在
- `'NoneType' object has no attribute 'username'` - 序列化器处理空值错误
- `ImportError` - 导入错误

### 3. 运行测试命令

```bash
python manage.py test_ai_config
```

这个命令会测试：
- 数据库表是否存在
- 序列化器是否正常工作
- 是否有其他错误

### 4. 手动测试API

使用curl或Postman测试API：

```bash
# 获取token（先登录）
curl -X POST http://localhost:8897/api/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{"username":"your_username","password":"your_password"}'

# 使用token获取配置列表
curl -X GET http://localhost:8897/api/reviews/ai-model-configs/ \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## 已修复的问题

### 1. 序列化器空值处理

**修复前：**
```python
created_by_name = serializers.CharField(source='created_by.username', read_only=True)
```

**修复后：**
```python
created_by_name = serializers.SerializerMethodField()

def get_created_by_name(self, obj):
    return obj.created_by.username if obj.created_by else ''
```

这样可以安全处理 `created_by` 为 `None` 的情况。

### 2. JSONField默认值

**修复前：**
```python
available_models = models.JSONField(default=list, ...)
```

**修复后：**
```python
available_models = models.JSONField(default=lambda: [], ...)
```

### 3. 查询优化

添加了 `select_related` 来避免N+1查询问题：

```python
def get_queryset(self):
    return AIModelConfig.objects.select_related('created_by', 'updated_by').all()
```

## 完整解决流程

1. **停止后端服务**（如果正在运行）

2. **运行数据库迁移**：
   ```bash
   cd backend
   python manage.py makemigrations reviews
   python manage.py migrate
   ```

3. **运行测试命令**：
   ```bash
   python manage.py test_ai_config
   ```

4. **重启后端服务**：
   ```bash
   python manage.py runserver 8897
   ```

5. **刷新前端页面**，重试

## 如果问题仍然存在

1. **查看后端完整错误堆栈**：
   - 在后端控制台查看完整的错误信息
   - 找到具体的错误行和错误原因

2. **检查Django设置**：
   ```bash
   python manage.py check
   ```

3. **检查数据库连接**：
   ```bash
   python manage.py dbshell
   # 然后执行：SELECT * FROM reviews_ai_model_config LIMIT 1;
   ```

4. **清除缓存**（如果使用了缓存）：
   ```bash
   python manage.py clear_cache
   ```

## 常见错误及解决方案

### 错误1：表不存在
```
django.db.utils.OperationalError: no such table: reviews_ai_model_config
```
**解决**：运行 `python manage.py migrate`

### 错误2：字段不存在
```
django.db.utils.OperationalError: no such column: reviews_ai_model_config.xxx
```
**解决**：检查迁移文件是否正确，重新运行迁移

### 错误3：序列化器错误
```
'NoneType' object has no attribute 'username'
```
**解决**：已修复，使用 `SerializerMethodField` 安全处理

### 错误4：导入错误
```
ImportError: cannot import name 'AIModelConfig'
```
**解决**：检查 `__init__.py` 文件，确保模型正确导入

---

**最后更新**：2024年12月22日

